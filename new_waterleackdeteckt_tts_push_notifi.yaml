blueprint:
  name: üíß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ—Ç–µ—á–∫–µ –≤–æ–¥—ã –ø–æ –∑–æ–Ω–∞–º —Å PUSH, TTS –∏ Telegram v15
  description: >-
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –≤ –æ–¥–Ω–æ–π –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö –∑–æ–Ω. –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç
    –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PUSH-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω,
    –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (TTS) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/new_waterleackdeteckt_tts_push_notifi.yaml
  
  input:
    zone_1_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 1
      description: –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö—É—Ö–Ω—è").
      selector:
        text:
      default: '–ó–æ–Ω–∞ 1'
    leak_sensors_zone_1:
      name: –î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –ó–æ–Ω—ã 1
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–æ–Ω—ã.
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_1:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –ó–æ–Ω—ã 1
      description: –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –≤ –ø–µ—Ä–≤–æ–π –∑–æ–Ω–µ.
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_2_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 2
      description: –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—Ç–æ—Ä–æ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–í–∞–Ω–Ω–∞—è").
      selector:
        text:
      default: '–ó–æ–Ω–∞ 2'
    leak_sensors_zone_2:
      name: –î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –ó–æ–Ω—ã 2
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–π –∑–æ–Ω—ã.
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_2:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –ó–æ–Ω—ã 2
      description: –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –≤–æ –≤—Ç–æ—Ä–æ–π –∑–æ–Ω–µ.
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_3_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 3
      description: –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö–æ—Ç–µ–ª—å–Ω–∞—è").
      selector:
        text:
      default: '–ó–æ–Ω–∞ 3'
    leak_sensors_zone_3:
      name: –î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –ó–æ–Ω—ã 3
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏ –¥–ª—è —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω—ã.
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_3:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –ó–æ–Ω—ã 3
      description: –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –≤ —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω–µ.
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_4_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 4
      description: –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω—ã.
      selector:
        text:
      default: '–ó–æ–Ω–∞ 4'
    leak_sensors_zone_4:
      name: –î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –ó–æ–Ω—ã 4
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏ –¥–ª—è —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω—ã.
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_4:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –ó–æ–Ω—ã 4
      description: –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–¥—ã –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω–µ.
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    notify_device:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è PUSH-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      description: –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è PUSH-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
      selector:
        device:
          integration: mobile_app
    telegram_notify_target:
      name: –°–ª—É–∂–±–∞ Telegram Notify
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å –≤–∞—à–µ–π —Å–ª—É–∂–±—ã Telegram (notify.telegram_bot_...). –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify
    notification_title:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫ PUSH-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      description: –£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è PUSH-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
      selector:
        text:
      default: 'üíß –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ü–†–û–¢–ï–ß–ö–ê!'
    tts_media_players:
      name: –ú–µ–¥–∏–∞–ø–ª–µ—Ä—ã –¥–ª—è TTS
      description: –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–¥–∏–∞–ø–ª–µ—Ä—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
      selector:
        entity:
          domain: media_player
          multiple: true
      default: []
    tts_service:
      name: –°–µ—Ä–≤–∏—Å TTS
      description: –£–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –¥–ª—è TTS, –Ω–∞–ø—Ä–∏–º–µ—Ä, tts.yandex_station_say –∏–ª–∏ tts.google_say.
      default: tts.yandex_station_say
      selector:
        text:
    tts_volume:
      name: –ì—Ä–æ–º–∫–æ—Å—Ç—å TTS
      description: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          mode: slider
      default: 0.7
    tts_delay_after_leak_message:
      name: –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–∏ –∫—Ä–∞–Ω–∞ (—Å–µ–∫—É–Ω–¥—ã)
      description: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –ø—Ä–æ—Ç–µ—á–∫–µ –∏ –≤—Ç–æ—Ä—ã–º –æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–∏ –∫—Ä–∞–Ω–∞.
      selector:
        number:
          min: 0
          max: 60
          step: 1
          mode: slider
      default: 8
    tts_delay_between_runs:
      name: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è–º–∏ (—Å–µ–∫—É–Ω–¥—ã)
      description: –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–ª–µ–¥—É—é—â–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å.
      selector:
        number:
          min: 0
          max: 60
          step: 1
          mode: slider
      default: 4
      
variables:
  telegram_target_id: !input telegram_notify_target
  
trigger:
- platform: state
  entity_id: !input 'leak_sensors_zone_1'
  to: 'on'
  alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –ø–µ—Ä–≤–æ–π –∑–æ–Ω–µ
- platform: state
  entity_id: !input 'leak_sensors_zone_2'
  to: 'on'
  alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–π –∑–æ–Ω–µ
- platform: state
  entity_id: !input 'leak_sensors_zone_3'
  to: 'on'
  alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω–µ
- platform: state
  entity_id: !input 'leak_sensors_zone_4'
  to: 'on'
  alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω–µ
condition:
- condition: template
  value_template: '{{ trigger.to_state.state != ''unknown'' }}'
- condition: template
  value_template: '{{ trigger.from_state.state != ''unknown'' }}'
action:
- choose:
  - conditions:
    - condition: template
      value_template: '{{ trigger.alias == ''–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –ø–µ—Ä–≤–æ–π –∑–æ–Ω–µ'' }}'
    sequence:
    - variables:
        zone_name: !input 'zone_1_name'
        water_shutoff_devices: !input 'water_shutoff_devices_zone_1'
    - service: homeassistant.turn_off
      target:
        entity_id: '{{ water_shutoff_devices }}'
    - if: '{{ notify_device is not none }}'
      then:
      - device_id: !input 'notify_device'
        domain: mobile_app
        type: notify
        title: !input 'notification_title'
        message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                chat_id: >
                  {% set entity_id = telegram_target_id.entity_id[0] %}
                  {% set parts = entity_id.split('_') %}
                  {{ parts[-1] }}
                # üì¢ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Telegram
                title: !input 'notification_title'
                message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
                parse_mode: markdown
    - service: media_player.volume_set
      target:
        entity_id: !input 'tts_media_players'
      data:
        volume_level: !input 'tts_volume'
    - service: !input 'tts_service'
      data:
        entity_id: !input 'tts_media_players'
        message: '–í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ {{ zone_name }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - delay:
        seconds: !input 'tts_delay_after_leak_message'
    - choose:
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == water_shutoff_devices | length }}'
        sequence:
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: '‚úÖ –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*‚úÖ –ö–†–ê–ù–´ –ó–ê–ö–†–´–¢–´.* –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length < water_shutoff_devices | length and water_shutoff_devices | select(''is_state'', ''off'') | list | length > 0 }}'
        sequence:
        - variables:
            closed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''eq'',''off'') | map(attribute=''name'') | list | join('', '') }}'
            failed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''ne'',''off'') | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ó–∞–∫—Ä—ã—Ç—ã –∫—Ä–∞–Ω—ã: {{ closed_valves }}. –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üö® –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üö® –û–®–ò–ë–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ö–†–ê–ù–û–í* –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == 0 and water_shutoff_devices | length > 0 }}'
        sequence:
        - variables:
            failed_valves: '{{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:* –ù–ò –û–î–ò–ù –ö–†–ê–ù –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
                    parse_mode: markdown
    - delay:
        seconds: !input 'tts_delay_between_runs'
    alias: –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–æ–Ω—ã
  - conditions:
    - condition: template
      value_template: '{{ trigger.alias == ''–ü—Ä–æ—Ç–µ—á–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–π –∑–æ–Ω–µ'' }}'
    sequence:
    - variables:
        zone_name: !input 'zone_2_name'
        water_shutoff_devices: !input 'water_shutoff_devices_zone_2'
    - service: homeassistant.turn_off
      target:
        entity_id: '{{ water_shutoff_devices }}'
    - if: '{{ notify_device is not none }}'
      then:
      - device_id: !input 'notify_device'
        domain: mobile_app
        type: notify
        title: !input 'notification_title'
        message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                chat_id: >
                  {% set entity_id = telegram_target_id.entity_id[0] %}
                  {% set parts = entity_id.split('_') %}
                  {{ parts[-1] }}
                # üì¢ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Telegram
                title: !input 'notification_title'
                message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
                parse_mode: markdown
    - service: media_player.volume_set
      target:
        entity_id: !input 'tts_media_players'
      data:
        volume_level: !input 'tts_volume'
    - service: !input 'tts_service'
      data:
        entity_id: !input 'tts_media_players'
        message: '–í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ {{ zone_name }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - delay:
        seconds: !input 'tts_delay_after_leak_message'
    - choose:
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == water_shutoff_devices | length }}'
        sequence:
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: '‚úÖ –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*‚úÖ –ö–†–ê–ù–´ –ó–ê–ö–†–´–¢–´.* –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length < water_shutoff_devices | length and water_shutoff_devices | select(''is_state'', ''off'') | list | length > 0 }}'
        sequence:
        - variables:
            closed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''eq'',''off'') | map(attribute=''name'') | list | join('', '') }}'
            failed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''ne'',''off'') | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ó–∞–∫—Ä—ã—Ç—ã –∫—Ä–∞–Ω—ã: {{ closed_valves }}. –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üö® –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üö® –û–®–ò–ë–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ö–†–ê–ù–û–í* –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == 0 and water_shutoff_devices | length > 0 }}'
        sequence:
        - variables:
            failed_valves: '{{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:* –ù–ò –û–î–ò–ù –ö–†–ê–ù –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
                    parse_mode: markdown
    - delay:
        seconds: !input 'tts_delay_between_runs'
    alias: –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –≤—Ç–æ—Ä–æ–π –∑–æ–Ω—ã
  - conditions:
    - condition: template
      value_template: '{{ trigger.alias == ''–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω–µ'' }}'
    sequence:
    - variables:
        zone_name: !input 'zone_3_name'
        water_shutoff_devices: !input 'water_shutoff_devices_zone_3'
    - service: homeassistant.turn_off
      target:
        entity_id: '{{ water_shutoff_devices }}'
    - if: '{{ notify_device is not none }}'
      then:
      - device_id: !input 'notify_device'
        domain: mobile_app
        type: notify
        title: !input 'notification_title'
        message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                chat_id: >
                  {% set entity_id = telegram_target_id.entity_id[0] %}
                  {% set parts = entity_id.split('_') %}
                  {{ parts[-1] }}
                # üì¢ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Telegram
                title: !input 'notification_title'
                message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
                parse_mode: markdown
    - service: media_player.volume_set
      target:
        entity_id: !input 'tts_media_players'
      data:
        volume_level: !input 'tts_volume'
    - service: !input 'tts_service'
      data:
        entity_id: !input 'tts_media_players'
        message: '–í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ {{ zone_name }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - delay:
        seconds: !input 'tts_delay_after_leak_message'
    - choose:
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == water_shutoff_devices | length }}'
        sequence:
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: '‚úÖ –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*‚úÖ –ö–†–ê–ù–´ –ó–ê–ö–†–´–¢–´.* –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length < water_shutoff_devices | length and water_shutoff_devices | select(''is_state'', ''off'') | list | length > 0 }}'
        sequence:
        - variables:
            closed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''eq'',''off'') | map(attribute=''name'') | list | join('', '') }}'
            failed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''ne'',''off'') | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ó–∞–∫—Ä—ã—Ç—ã –∫—Ä–∞–Ω—ã: {{ closed_valves }}. –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üö® –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üö® –û–®–ò–ë–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ö–†–ê–ù–û–í* –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == 0 and water_shutoff_devices | length > 0 }}'
        sequence:
        - variables:
            failed_valves: '{{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:* –ù–ò –û–î–ò–ù –ö–†–ê–ù –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
                    parse_mode: markdown
    - delay:
        seconds: !input 'tts_delay_between_runs'
    alias: –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω—ã
  - conditions:
    - condition: template
      value_template: '{{ trigger.alias == ''–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω–µ'' }}'
    sequence:
    - variables:
        zone_name: !input 'zone_4_name'
        water_shutoff_devices: !input 'water_shutoff_devices_zone_4'
    - service: homeassistant.turn_off
      target:
        entity_id: '{{ water_shutoff_devices }}'
    - if: '{{ notify_device is not none }}'
      then:
      - device_id: !input 'notify_device'
        domain: mobile_app
        type: notify
        title: !input 'notification_title'
        message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                chat_id: >
                  {% set entity_id = telegram_target_id.entity_id[0] %}
                  {% set parts = entity_id.split('_') %}
                  {{ parts[-1] }}
                # üì¢ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Telegram
                title: !input 'notification_title'
                message: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''! –î–∞—Ç—á–∏–∫: {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
                parse_mode: markdown
    - service: media_player.volume_set
      target:
        entity_id: !input 'tts_media_players'
      data:
        volume_level: !input 'tts_volume'
    - service: !input 'tts_service'
      data:
        entity_id: !input 'tts_media_players'
        message: '–í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã –≤ –∑–æ–Ω–µ {{ zone_name }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ trigger.to_state.name | replace('' Water leak detected'', '''') }}. {% if water_shutoff_devices | length > 0 %} –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã: {{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}.{% endif %}'
    - delay:
        seconds: !input 'tts_delay_after_leak_message'
    - choose:
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == water_shutoff_devices | length }}'
        sequence:
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: '‚úÖ –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*‚úÖ –ö–†–ê–ù–´ –ó–ê–ö–†–´–¢–´.* –Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''.'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length < water_shutoff_devices | length and water_shutoff_devices | select(''is_state'', ''off'') | list | length > 0 }}'
        sequence:
        - variables:
            closed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''eq'',''off'') | map(attribute=''name'') | list | join('', '') }}'
            failed_valves: '{{ expand(water_shutoff_devices) | selectattr(''state'',''ne'',''off'') | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ó–∞–∫—Ä—ã—Ç—ã –∫—Ä–∞–Ω—ã: {{ closed_valves }}. –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üö® –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üö® –û–®–ò–ë–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ö–†–ê–ù–û–í* –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã: {{ closed_valves }}. ‚ùå –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed_valves }}'
                    parse_mode: markdown
      - conditions: '{{ water_shutoff_devices | select(''is_state'', ''off'') | list | length == 0 and water_shutoff_devices | length > 0 }}'
        sequence:
        - variables:
            failed_valves: '{{ expand(water_shutoff_devices) | map(attribute=''name'') | list | join('', '') }}'
        - service: !input 'tts_service'
          data:
            entity_id: !input 'tts_media_players'
            message: '–Ø –Ω–µ —Å–º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ ''{{ zone_name }}''. –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - if: '{{ notify_device is not none }}'
          then:
          - device_id: !input 'notify_device'
            domain: mobile_app
            type: notify
            message: 'üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ù–∏ –æ–¥–∏–Ω –∫—Ä–∞–Ω –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ telegram_target_id.entity_id | length > 0 }}"
              sequence:
                - service: telegram_bot.send_message
                  data:
                    chat_id: >
                      {% set entity_id = telegram_target_id.entity_id[0] %}
                      {% set parts = entity_id.split('_') %}
                      {{ parts[-1] }}
                    # üì¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    message: '*üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:* –ù–ò –û–î–ò–ù –ö–†–ê–ù –≤ –∑–æ–Ω–µ ''{{ zone_name }}'' –Ω–µ –∑–∞–∫—Ä—ã—Ç: {{ failed_valves }}'
                    parse_mode: markdown
    - delay:
        seconds: !input 'tts_delay_between_runs'
    alias: –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω—ã
mode: queued