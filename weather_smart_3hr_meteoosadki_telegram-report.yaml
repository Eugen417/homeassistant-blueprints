blueprint:
  name: "ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ: ĞÑĞ°Ğ´ĞºĞ¸ (ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°) v1.2"
  description: >
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ¿Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ. Ğ•ÑĞ»Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğµ 3 Ğ§ĞĞ¡Ğ (Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸) Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‚ÑÑ Ğ¾ÑĞ°Ğ´ĞºĞ¸ â€” ÑˆĞ»ĞµÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ.
    Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑĞ»Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ñ‹.
  domain: automation

  input:
    weather_entity:
      name: "ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ½Ğ°Ñ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ÑŒ"
      description: Ğ’Ğ°Ñˆ weather.yandex_pogoda Ğ¸Ğ»Ğ¸ OpenMeteo
      selector:
        entity:
          domain: weather

    check_frequency:
      name: "Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸"
      description: "ĞšĞ°Ğº Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·?"
      default: "/30"
      selector:
        select:
          options:
            - label: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
              value: "/10"
            - label: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
              value: "/15"
            - label: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 20 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
              value: "/20"
            - label: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
              value: "/30"
            - label: "Ğ Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ (Ñ€Ğ¾Ğ²Ğ½Ğ¾ Ğ² :00)"
              value: "0"

    telegram_notify_target:
      name: "ğŸ’¬ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Telegram"
      description: Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ (notify.telegram_...).
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

    map_url:
      name: "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ (Windy)"
      description: "Ğ§Ğ¸ÑÑ‚Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° (https://...) Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸."
      default: "https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=5&overlay=rain&product=ecmwf&level=surface&lat=55.672&lon=37.855"
      selector:
        text: {}

variables:
  weather_entity: !input weather_entity
  telegram_notify_target: !input telegram_notify_target
  map_link: !input map_url

  # --- Ğ›ĞĞ“Ğ˜ĞšĞ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ•ĞĞ˜Ğ¯ ID ---
  target_chat_ids: >-
    {% set selected_entities_raw = telegram_notify_target.entity_id | default([]) %}
    {% set selected_entities = [selected_entities_raw] | flatten %}
    {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
    {% set ns = namespace(target_ids=[]) %}
    {% for id_string in chat_id_strings %}
      {% set cleaned_id = id_string | string | trim %}
      {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
        {% set id_with_hyphen = '-' ~ cleaned_id %}
        {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
      {% else %}
        {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
      {% endif %}
    {% endfor %}
    {{ ns.target_ids }}

trigger:
  - platform: time_pattern
    minutes: !input check_frequency

action:
  - if:
      - condition: template
        value_template: "{{ target_chat_ids | length == 0 }}"
    then:
      - stop: "ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ğ¸ Telegram"

  - action: weather.get_forecasts
    target:
      entity_id: !input weather_entity
    data:
      type: hourly
    response_variable: weather_data

  # --- Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ---
  - if:
      - condition: template
        value_template: >
          {% set forecast = weather_data[weather_entity].forecast %}
          {% set bad_weather = ['rainy', 'pouring', 'lightning-rainy', 'snowy-rainy', 'snowy', 'hail'] %}
          
          {# 1. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ñ‡Ğ°ÑÑ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ #}
          {% set future_forecast = [] %}
          {% for h in forecast %}
            {% if as_timestamp(h.datetime) >= as_timestamp(now()) %}
              {% set future_forecast = future_forecast + [h] %}
            {% endif %}
          {% endfor %}
          
          {# 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 3 Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ñ… Ñ‡Ğ°ÑĞ° Ğ˜Ğ— Ğ‘Ğ£Ğ”Ğ£Ğ©Ğ•Ğ“Ğ #}
          {{ future_forecast[:3] | selectattr('condition', 'in', bad_weather) | list | count > 0 }}
          
    then:
      - action: telegram_bot.send_message
        metadata: {}
        data:
          target: "{{ target_chat_ids }}"
          parse_mode: html
          title: "â˜”ï¸ ĞÑĞ°Ğ´ĞºĞ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ!"
          message: >
            {%- set forecast = weather_data[weather_entity].forecast -%}
            {%- set bad_weather = ['rainy', 'pouring', 'lightning-rainy', 'snowy-rainy', 'snowy', 'hail'] -%}
            {%- set mapper = {
              'rainy': 'Ğ”Ğ¾Ğ¶Ğ´ÑŒ ğŸŒ§', 'pouring': 'Ğ›Ğ¸Ğ²ĞµĞ½ÑŒ â›ˆ', 'lightning-rainy': 'Ğ“Ñ€Ğ¾Ğ·Ğ° â›ˆ',
              'snowy-rainy': 'Ğ¡Ğ½ĞµĞ³ Ñ Ğ´Ğ¾Ğ¶Ğ´ĞµĞ¼ ğŸ’§â„ï¸', 'snowy': 'Ğ¡Ğ½ĞµĞ³ â„ï¸', 'hail': 'Ğ“Ñ€Ğ°Ğ´ ğŸŒ¨'
            } -%}
            
            {# Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğµ #}
            {%- set future_forecast = [] -%}
            {%- for h in forecast -%}
              {%- if as_timestamp(h.datetime) >= as_timestamp(now()) -%}
                {%- set future_forecast = future_forecast + [h] -%}
              {%- endif -%}
            {%- endfor -%}

            <b>Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ñ‡Ğ°ÑĞ°:</b>
            {%- set ns = namespace(blocks=[], current_block=[]) -%}
            {%- for hour in future_forecast[:3] if hour.condition in bad_weather -%}
              {%- set prev = ns.current_block[-1] if ns.current_block else none -%}
              {%- if prev and (as_timestamp(hour.datetime) - as_timestamp(prev.datetime)) == 3600 -%}
                {%- set ns.current_block = ns.current_block + [hour] -%}
              {%- else -%}
                {%- if ns.current_block -%}
                  {%- set ns.blocks = ns.blocks + [ns.current_block] -%}
                {%- endif -%}
                {%- set ns.current_block = [hour] -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if ns.current_block -%}
              {%- set ns.blocks = ns.blocks + [ns.current_block] -%}
            {%- endif -%}
            
            {%- for block in ns.blocks -%}
              {%- set start = block[0] -%}
              {%- set end = block[-1] -%}
              {%- set c_name = mapper[start.condition] if start.condition in mapper else start.condition -%}
              {%- if start == end -%}
            {{'\n'}}ğŸ•’ <b>{{ as_timestamp(start.datetime) | timestamp_custom('%H:%M') }}</b> {{ c_name }} ({{ start.temperature }}Â°C)
              {%- else -%}
                {%- set end_time = as_timestamp(end.datetime) + 3600 -%}
            {{'\n'}}ğŸ•’ <b>{{ as_timestamp(start.datetime) | timestamp_custom('%H:%M') }}â€“{{ end_time | timestamp_custom('%H:%M') }}</b> {{ c_name }} ({{ start.temperature }}Â°C)
              {%- endif -%}
            {%- endfor -%}
            
            {% if map_link != '' %}
            {{'\n'}}<a href="{{ map_link }}">ğŸ—º ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ¾ÑĞ°Ğ´ĞºĞ¾Ğ²</a>
            {% endif %}
