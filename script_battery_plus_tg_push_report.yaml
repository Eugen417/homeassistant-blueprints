blueprint:
  name: ü™´ –°–∫—Ä–∏–ø—Ç –æ—Ç—á–µ—Ç–∞ –ø–æ –±–∞—Ç–∞—Ä–µ—è–º (v1.0.0)
  description: |
    –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–∞—Ç–∞—Ä–µ–π (–Ω–∞ –æ—Å–Ω–æ–≤–µ v3.8.1).
    
    –°–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç—ã ("–ó–∞–º–µ–Ω–∞", "–ó–∞—Ä—è–¥–∫–∞" –∏ "–ü–æ–ª–Ω—ã–π") –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ Telegram (HTML) –∏–ª–∏ App.
    –í –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –≤–∫–ª—é—á–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –ø–æ—Ç–µ—Ä—è–≤—à–∏–µ —Å–≤—è–∑—å (Unavailable).
    
    **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è HA-Battery Notes.
  domain: script
  
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/script_battery_plus_tg_push_report.yaml


  input:
    # 1. –£–°–¢–†–û–ô–°–¢–í–ê –ò –ü–û–†–û–ì–ò
    mobile_notify_target:
      name: üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
      description: –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ.
      default: ""
      selector:
        device:
          integration: mobile_app
    
    telegram_notify_target:
      name: üí¨ Telegram
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ notify.telegram_bot_.... –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

    send_full_report_option:
      name: üìä –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç?
      description: –í–∫–ª—é—á–∏—Ç–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–≤—Ç–æ—Ä—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤ Telegram).
      default: false
      selector:
        boolean:

    critical_level:
      name: ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å (%)
      description: –ü–æ—Ä–æ–≥ –∑–∞—Ä—è–¥–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–º–µ–Ω–µ/–∑–∞—Ä—è–¥–∫–µ.
      default: 15
      selector:
        number:
          min: 1
          max: 99
          step: 1
          unit_of_measurement: "%"
          mode: box
          
    excluded_sensors:
      name: üóëÔ∏è –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Å–µ–Ω—Å–æ—Ä—ã
      description: –°–µ–Ω—Å–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: sensor
              device_class: battery

    # 2. –ù–ê–°–¢–†–û–ô–ö–ê –¢–ï–ö–°–¢–ê
    text_disposable_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ó–∞–º–µ–Ω–∞)
      default: "‚ö†Ô∏è <b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –∑–∞–º–µ–Ω—ã –±–∞—Ç–∞—Ä–µ–∏:</b>\n"
      selector:
        text:
    text_disposable_action:
      name: üìù –®–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏ (–ó–∞–º–µ–Ω–∞)
      default: "<b>%LEVEL%%</b> ‚ôªÔ∏è –ó–ê–ú–ï–ù–ê! (–¢–∏–ø: %TYPE%, –ö–æ–ª-–≤–æ: %QTY%)"
      selector:
        text:
    text_disposable_ok:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ (–ó–∞–º–µ–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      default: "–í—Å–µ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã–µ –±–∞—Ç–∞—Ä–µ–∏ –∏–º–µ—é—Ç –∑–∞—Ä—è–¥ –≤—ã—à–µ "
      selector:
        text:
    text_rechargeable_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ó–∞—Ä—è–¥–∫–∞)
      default: "‚ö†Ô∏è <b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–¥–∑–∞—Ä—è–¥–∫–∏:</b>\n"
      selector:
        text:
    text_rechargeable_action:
      name: üìù –®–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏ (–ó–∞—Ä—è–¥–∫–∞)
      default: "<b>%LEVEL%%</b> üîå –ó–ê–†–Ø–î–ö–ê!"
      selector:
        text:
    text_rechargeable_ok:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ (–ó–∞—Ä—è–¥–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      default: "–í—Å–µ –∑–∞—Ä—è–∂–∞–µ–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–º–µ—é—Ç –∑–∞—Ä—è–¥ –≤—ã—à–µ "
      selector:
        text:
    text_full_replace_label:
      name: üìù –ú–µ—Ç–∫–∞ –∑–∞–º–µ–Ω—ã (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: " ‚ôªÔ∏è <b>–ó–ê–ú–ï–ù–ê!</b>"
      selector:
        text:
    text_full_charge_label:
      name: üìù –ú–µ—Ç–∫–∞ –∑–∞—Ä—è–¥–∫–∏ (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: " üîå <b>–ó–ê–†–Ø–î–ö–ê!</b>"
      selector:
        text:
    text_rechargeable_type:
      name: üìù –ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ê–ö–ë
      default: "–í—Å—Ç—Ä–æ–µ–Ω—ã–π –ê–ö–ë"
      selector:
        text:
    text_unknown_type:
      name: üìù –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
      default: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¢–∏–ø"
      selector:
        text:
    text_summary_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–æ–¥–∫–∏
      default: "--- \n\nüîã <b>–°–≤–æ–¥–∫–∞ –ø–æ –¢–∏–ø—É –ë–∞—Ç–∞—Ä–µ–∏:</b>\n"
      selector:
        text:
    text_grand_total:
      name: üìù –®–∞–±–ª–æ–Ω –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      default: "<i>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤:</i> <b>%TOTAL%</b> —à—Ç."
      selector:
        text:
    text_offline_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (Offline)
      default: "‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±–µ–∑ —Å–≤—è–∑–∏ (Unavailable/Unknown):</b>"
      selector:
        text:
    text_no_sensors:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ—Ç —Å–µ–Ω—Å–æ—Ä–æ–≤
      default: "–°–µ–Ω—Å–æ—Ä—ã –±–∞—Ç–∞—Ä–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
      selector:
        text:
    text_no_summary_data:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ—Ç —Å–≤–æ–¥–∫–∏
      default: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–ø–∞—Ö –±–∞—Ç–∞—Ä–µ–π –¥–ª—è –æ—Ç—á–µ—Ç–∞."
      selector:
        text:
    title_short_replace_low:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ App (–ó–∞–º–µ–Ω–∞, –ù–∏–∑–∫–∏–π)
      default: "üîã –ë–∞—Ç–∞—Ä–µ—è+: ü™´‚ôªÔ∏è –ó–∞—Ä—è–¥ < "
      selector:
        text:
    title_short_replace_ok:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ App (–ó–∞–º–µ–Ω–∞, OK)
      default: "üîã –ë–∞—Ç–∞—Ä–µ—è+: –ó–∞–º–µ–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
      selector:
        text:
    title_short_charge_low:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ App (–ó–∞—Ä—è–¥–∫–∞, –ù–∏–∑–∫–∏–π)
      default: "üîã –ë–∞—Ç–∞—Ä–µ—è+: ü™´üîå –ó–∞—Ä—è–¥ < "
      selector:
        text:
    title_short_charge_ok:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ App (–ó–∞—Ä—è–¥–∫–∞, OK)
      default: "üîã –ë–∞—Ç–∞—Ä–µ—è+: –ó–∞—Ä—è–¥–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
      selector:
        text:
    title_full_report:
      name: üìä –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: "üîã <b>–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ë–∞—Ç–∞—Ä–µ—è+ (–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é):</b>"
      selector:
        text:

variables:
  mobile_device_id: !input mobile_notify_target
  telegram_notify_entities: !input telegram_notify_target 
  critical_threshold: !input critical_level
  excluded_entity_ids: !input excluded_sensors
  send_full_report: !input send_full_report_option
  # Text variables
  text_disposable_header: !input text_disposable_header
  text_disposable_action: !input text_disposable_action
  text_disposable_ok: !input text_disposable_ok
  text_rechargeable_header: !input text_rechargeable_header
  text_rechargeable_action: !input text_rechargeable_action
  text_rechargeable_ok: !input text_rechargeable_ok
  text_full_replace_label: !input text_full_replace_label
  text_full_charge_label: !input text_full_charge_label
  text_rechargeable_type: !input text_rechargeable_type
  text_unknown_type: !input text_unknown_type
  text_summary_header: !input text_summary_header
  text_grand_total: !input text_grand_total
  text_offline_header: !input text_offline_header
  text_no_sensors: !input text_no_sensors
  text_no_summary_data: !input text_no_summary_data
  title_short_replace_low: !input title_short_replace_low
  title_short_replace_ok: !input title_short_replace_ok
  title_short_charge_low: !input title_short_charge_low
  title_short_charge_ok: !input title_short_charge_ok
  title_full_report: !input title_full_report

sequence:
  # ----------------------------------------------------------------------
  # 1. –†–ê–°–°–ß–ï–¢ –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
  # ----------------------------------------------------------------------
  - alias: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ—Ç—á–µ—Ç—ã
    variables:
      threshold: "{{ critical_threshold | int }}"
      exclude_list: "{{ excluded_entity_ids.entity_id | default([]) }}"
      
      # 1.1 –ó–∞–º–µ–Ω–∞ (Disposable)
      disposable_message: >-
        {% set ns = namespace(disposable_lines=[]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            {% if numerical_level >= 0 and numerical_level < threshold %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %} 
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              {% if not is_rechargeable %}
                {% set battery_quantity = sensor.attributes.battery_quantity | default('1') | string %}
                {% set escaped_battery_type = battery_type | string | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set escaped_name = cleaned_name | string | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set escaped_quantity = battery_quantity | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set line_action = text_disposable_action | replace('%LEVEL%', numerical_level | string) | replace('%TYPE%', escaped_battery_type) | replace('%QTY%', escaped_quantity) %}
                {% set line = escaped_name ~ ": " ~ line_action %}
                {% set ns.disposable_lines = ns.disposable_lines + [{ 'level': numerical_level, 'line': line }] %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_disposable = ns.disposable_lines | sort(attribute='level') %}
        {% set disposable_output = sorted_disposable | map(attribute='line') | list %}
        {% if disposable_output | length > 0 %}
          {{ text_disposable_header ~ disposable_output | join('\n') }}
        {% else %}
          {{ text_disposable_ok ~ critical_threshold ~ "%." }}
        {% endif %}

      # 1.2 –ó–∞—Ä—è–¥–∫–∞ (Rechargeable)
      rechargeable_message: >-
        {% set ns = namespace(rechargeable_lines=[]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            {% if numerical_level >= 0 and numerical_level < threshold %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %}
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              {% if is_rechargeable %}
                {% set escaped_name = cleaned_name | string | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set line_action = text_rechargeable_action | replace('%LEVEL%', numerical_level | string) %}
                {% set line = escaped_name ~ ": " ~ line_action %}
                {% set ns.rechargeable_lines = ns.rechargeable_lines + [{ 'level': numerical_level, 'line': line }] %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_rechargeable = ns.rechargeable_lines | sort(attribute='level') %}
        {% set rechargeable_output = sorted_rechargeable | map(attribute='line') | list %}
        {% if rechargeable_output | length > 0 %}
          {{ text_rechargeable_header ~ rechargeable_output | join('\n') }}
        {% else %}
          {{ text_rechargeable_ok ~ critical_threshold ~ "%." }}
        {% endif %}
      
      # 1.3 –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç (–¢–µ–ª–æ)
      full_report_body_list: >-
        {% set ns = namespace(all_lines=[]) %}
        {% set yellow_boundary = 40 %}
        {% set red_boundary = 15 %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            {% if numerical_level >= 0 %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %} 
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              {% set status_icon = 'üü¢' %} 
              {% if numerical_level < red_boundary %} {% set status_icon = 'üî¥' %}
              {% elif numerical_level < yellow_boundary %} {% set status_icon = 'üü°' %}
              {% endif %}
              {% set status_label = '' %}
              {% if numerical_level < threshold %}
                {% set status_label = text_full_replace_label if not is_rechargeable else text_full_charge_label %}
              {% endif %}
              {% set details = "" %}
              {% if not is_rechargeable %}
                {% set battery_quantity = sensor.attributes.battery_quantity | default('1') | string %}
                {% set escaped_battery_type = battery_type | string | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set escaped_quantity = battery_quantity | replace('<', '&lt;') | replace('>', '&gt;') %}
                {% set details = " (–¢–∏–ø: " ~ escaped_battery_type ~ ", –ö–æ–ª-–≤–æ: " ~ escaped_quantity ~ " —à—Ç)" %}
              {% endif %}
              {% set escaped_name = cleaned_name | string | replace('<', '&lt;') | replace('>', '&gt;') %}
              {% set line = status_icon ~ " " ~ escaped_name ~ ": " ~ numerical_level ~ "%" ~ status_label ~ details %}
              {% set ns.all_lines = ns.all_lines + [{ 'level': numerical_level, 'line': line }] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_all = ns.all_lines | sort(attribute='level', reverse=true) %}
        {% set all_output = sorted_all | map(attribute='line') | list %}
        {% if all_output | length > 0 %}
          {{ all_output | join('\n') }}
        {% else %}
          {{ text_no_sensors }}
        {% endif %}
        
      # 1.4 –°–≤–æ–¥–∫–∞ –ø–æ —Ç–∏–ø–∞–º
      battery_types_summary: >-
        {% set ns = namespace(output_lines=[]) %}
        {% set all_battery_sensors = states.sensor | selectattr('attributes.battery_last_reported_level', 'defined') | rejectattr('entity_id', 'in', exclude_list) | list %}
        {% set grouped_by_type = all_battery_sensors | groupby('attributes.battery_type') %}
        {% for type, sensors in grouped_by_type %}
          {% set total_quantity = namespace(value=0) %}
          {% for sensor in sensors %}
            {% set quantity = sensor.attributes.battery_quantity | default('1') | int(default=1) %}
            {% set total_quantity.value = total_quantity.value + quantity %}
          {% endfor %}
          {% set display_type = type | default(text_unknown_type) | string %}
          {% if display_type == 'Rechargeable' %} {% set display_type = text_rechargeable_type %} {% endif %}
          {% set escaped_display_type = display_type | replace('<', '&lt;') | replace('>', '&gt;') %}
          {% set line = "‚Ä¢ " ~ escaped_display_type ~ " (–í—Å–µ–≥–æ: " ~ total_quantity.value ~ " —à—Ç)" %}
          {% set ns.output_lines = ns.output_lines + [line] %}
        {% endfor %}
        {% if ns.output_lines | length > 0 %}
          {{ text_summary_header ~ ns.output_lines | sort | join('\n') }}
        {% else %}
          {{ text_no_summary_data }}
        {% endif %}
      
      # 1.5 –û—Ñ—Ñ–ª–∞–π–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      offline_sensors_report: >-
        {% set ns = namespace(offline_lines=[]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% if sensor.state in ['unavailable', 'unknown'] %}
              {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %}
              {% set escaped_name = cleaned_name | string | replace('<', '&lt;') | replace('>', '&gt;') %}
              {% set line = "‚ùì " ~ escaped_name ~ " (–°—Ç–∞—Ç—É—Å: " ~ sensor.state ~ ")" %}
              {% set ns.offline_lines = ns.offline_lines + [line] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if ns.offline_lines | length > 0 %}
          {{ text_offline_header ~ '\n' ~ ns.offline_lines | join('\n') }}
        {% endif %}

      # 1.6 –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ–±—â–µ–≥–æ –∫–æ–ª-–≤–∞
      grand_total_quantity: >-
        {% set total = namespace(value=0) %}
        {% set exclude_list_local = excluded_entity_ids.entity_id | default([]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list_local %}
            {% set quantity = sensor.attributes.battery_quantity | default('1') | int(default=1) %}
            {% set total.value = total.value + quantity %}
          {% endif %}
        {% endfor %}
        {{ total.value }}
        
      # 1.7 –°–±–æ—Ä–∫–∞ –ü–û–õ–ù–û–ì–û –æ—Ç—á–µ—Ç–∞
      full_report_message: >
        {% set total_text = text_grand_total | replace('%TOTAL%', grand_total_quantity | default(0) | string) %}
        {% set header = title_full_report %}
        {{ header ~ '\n' ~ total_text ~ '\n\n' ~ full_report_body_list ~ '\n\n' ~ battery_types_summary ~ '\n\n' ~ offline_sensors_report }}

  # ----------------------------------------------------------------------
  # 2. –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
  # ----------------------------------------------------------------------
  
  # 2.1 –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø—É—à, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å)
  - alias: Send Mobile Notification
    choose:
      - conditions:
          - condition: template
            value_template: "{{ mobile_device_id is not none and mobile_device_id != '' }}"
        sequence:
          - service: notify.mobile_app_{{ device_attr(mobile_device_id, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
            data:
              title: >
                {% if disposable_message.startswith('‚ö†Ô∏è') or rechargeable_message.startswith('‚ö†Ô∏è') %}
                  {{ title_short_replace_low ~ critical_threshold ~ "%" }}
                {% else %}
                  {{ title_short_replace_ok }}
                {% endif %}
              message: "{{ disposable_message | striptags }}\n\n{{ rechargeable_message | striptags }}"

  # 2.2 Telegram Bot (HTML)
  - alias: Prepare Telegram Target IDs
    variables:
      target_chat_ids: >-
        {% set selected_entities_raw = telegram_notify_entities.entity_id | default([]) %}
        {% set selected_entities = [selected_entities_raw] | flatten %}
        {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
        {% set ns = namespace(target_ids=[]) %}
        {% for id_string in chat_id_strings %}
          {% set cleaned_id = id_string | string | trim %}
          {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
            {% set ns.target_ids = ns.target_ids + ['-' ~ cleaned_id] %}
          {% else %}
            {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
          {% endif %}
        {% endfor %}
        {{ ns.target_ids }}

  - alias: Send Telegram Messages
    choose:
      - conditions:
          - condition: template
            value_template: "{{ target_chat_ids | length > 0 }}"
        sequence:
          # –û—Ç—á–µ—Ç –æ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã—Ö
          - service: telegram_bot.send_message
            data:
              target: "{{ target_chat_ids }}" 
              message: |
                {% set report_body = disposable_message %}
                {% if report_body.startswith('‚ö†Ô∏è') %}
                  {% set header = '<b>' ~ title_short_replace_low ~ critical_threshold ~ '%</b>' %}
                {% else %}
                  {% set header = '<b>' ~ title_short_replace_ok ~ '</b>' %}
                {% endif %}
                {{ header ~ "\n\n" ~ report_body }}
              parse_mode: html
          
          # –û—Ç—á–µ—Ç –æ –∑–∞—Ä—è–∂–∞–µ–º—ã—Ö
          - service: telegram_bot.send_message
            data:
              target: "{{ target_chat_ids }}" 
              message: |
                {% set report_body = rechargeable_message %}
                {% if report_body.startswith('‚ö†Ô∏è') %}
                  {% set header = '<b>' ~ title_short_charge_low ~ critical_threshold ~ '%</b>' %}
                {% else %}
                  {% set header = '<b>' ~ title_short_charge_ok ~ '</b>' %}
                {% endif %}
                {{ header ~ "\n\n" ~ report_body }}
              parse_mode: html

          # –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç (–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ send_full_report }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: "{{ target_chat_ids }}" 
                      message: "{{ full_report_message }}"
                      parse_mode: html

mode: single
