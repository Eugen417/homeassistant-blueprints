blueprint:
  name: üìä –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –û—Ç—á–µ—Ç (–í–°–ï –∫–ª–∞—Å—Å—ã) 
  description: –°–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –í–°–ï–ú –¥–∞—Ç—á–∏–∫–∞–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –∏ –æ—á–∏—â–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É Jinja. –í–∫–ª—é—á–µ–Ω—ã –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–µ–Ω—Å–æ—Ä–æ–≤.
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/sensor_state_notify.yaml 

  input:
    report_interval_pattern:
      name: –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç—á–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /5)
      description: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ /N (–Ω–∞–ø—Ä–∏–º–µ—Ä, /5 –¥–ª—è –∫–∞–∂–¥—ã—Ö 5 –º–∏–Ω—É—Ç).
      default: "/30" 
      selector:
        text:
          type: text
          
    target_device_class:
      name: –ö–ª–∞—Å—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (device_class)
      description: –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞.
      default: temperature 
      selector:
        select:
          options:
            - label: –í–µ—Å (weight)
              value: weight
            - label: –í–ª–∞–∂–Ω–æ—Å—Ç—å (humidity)
              value: humidity
            - label: –í–æ–¥–∞ (water)
              value: water
            - label: –ì–∞–∑ (gas)
              value: gas
            - label: –î–∞–≤–ª–µ–Ω–∏–µ (pressure)
              value: pressure
            - label: –ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ (battery)
              value: battery
            - label: –ò–Ω–¥–µ–∫—Å –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞ (AQI)
              value: aqi
            - label: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–æ—â–Ω–æ—Å—Ç–∏ (power_factor)
              value: power_factor
            - label: –õ–û–° (Volatile Organic Compounds)
              value: volatile_organic_compounds
            - label: –ú–æ—â–Ω–æ—Å—Ç—å (power)
              value: power
            - label: –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ (voltage)
              value: voltage
            - label: –û–±—ä–µ–º (volume)
              value: volume
            - label: –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö (data_size)
              value: data_size
            - label: –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å (illuminance)
              value: illuminance
            - label: –ü–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (apparent_power)
              value: apparent_power
            - label: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (duration)
              value: duration
            - label: –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (distance)
              value: distance
            - label: –†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (reactive_power)
              value: reactive_power
            - label: –°–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞ (signal_strength)
              value: signal_strength
            - label: –°–∫–æ—Ä–æ—Å—Ç—å (speed)
              value: speed
            - label: –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ (wind_speed)
              value: wind_speed
            - label: –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö (data_rate)
              value: data_rate
            - label: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (temperature)
              value: temperature
            - label: –¢–æ–∫ (current)
              value: current
            - label: –¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM1 (pm1)
              value: pm1
            - label: –¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM10 (pm10)
              value: pm10
            - label: –¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM2.5 (pm25)
              value: pm25
            - label: –£–≥–∞—Ä–Ω—ã–π –≥–∞–∑ (carbon_monoxide)
              value: carbon_monoxide
            - label: –£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑ (carbon_dioxide)
              value: carbon_dioxide
            - label: –§–∏–Ω–∞–Ω—Å—ã/–í–∞–ª—é—Ç–∞ (monetary)
              value: monetary
            - label: –ß–∞—Å—Ç–æ—Ç–∞ (frequency)
              value: frequency
            - label: –≠–Ω–µ—Ä–≥–∏—è (energy)
              value: energy
          mode: dropdown
          
    exclude_sensors:
      name: –î–∞—Ç—á–∏–∫–∏ –¥–ª—è –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø –∏–∑ –æ—Ç—á–µ—Ç–∞
      description: –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ –æ—Ç—á–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: sensor
            
    telegram_notify_target:
      name: üí¨ –¶–µ–ª–µ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ Telegram.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

variables:
  target_class: !input target_device_class
  exclude_input: !input exclude_sensors
  telegram_target_input: !input telegram_notify_target
          
mode: single

trigger:
  - platform: time_pattern
    minutes: !input report_interval_pattern

action:
  - service: telegram_bot.send_message
    data:
      
      # 1. –õ–û–ì–ò–ö–ê TARGET
      target: >-
        {% set target_input = telegram_target_input | default({}) %}
        {% set selected_entities = target_input.entity_id | default([]) | flatten %}
        {% set entity_ids_only = selected_entities | map('regex_replace', find='^notify\..+_', replace='') | list %}
        {% set ns = namespace(target_ids=[]) %}
        {% for id_string in entity_ids_only %}
          {% set cleaned_id = id_string | string | trim %}
          {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
            {% set id_with_hyphen = '-' ~ cleaned_id %}
            {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
          {% else %}
            {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
          {% endif %}
        {% endfor %}
        {{ ns.target_ids }}
        
      # 2. –¢–ï–õ–û –°–û–û–ë–©–ï–ù–ò–Ø (–í–ö–õ–Æ–ß–ê–Ø –†–£–°–°–ö–û–Ø–ó–´–ß–ù–´–ï –õ–ï–ô–ë–õ–´ –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–ê)
      message: |
        {% set class_labels = {
          'aqi': '–ò–Ω–¥–µ–∫—Å –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞ (AQI)',
          'apparent_power': '–ü–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å',
          'battery': '–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏',
          'carbon_dioxide': '–£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑',
          'carbon_monoxide': '–£–≥–∞—Ä–Ω—ã–π –≥–∞–∑',
          'current': '–¢–æ–∫',
          'data_rate': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö',
          'data_size': '–û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö',
          'distance': '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ',
          'duration': '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
          'energy': '–≠–Ω–µ—Ä–≥–∏—è',
          'frequency': '–ß–∞—Å—Ç–æ—Ç–∞',
          'gas': '–ì–∞–∑',
          'humidity': '–í–ª–∞–∂–Ω–æ—Å—Ç—å',
          'illuminance': '–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å',
          'monetary': '–§–∏–Ω–∞–Ω—Å—ã/–í–∞–ª—é—Ç–∞',
          'pm1': '–¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM1',
          'pm25': '–¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM2.5',
          'pm10': '–¢–≤–µ—Ä–¥—ã–µ —á–∞—Å—Ç–∏—Ü—ã PM10',
          'power': '–ú–æ—â–Ω–æ—Å—Ç—å',
          'power_factor': '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–æ—â–Ω–æ—Å—Ç–∏',
          'pressure': '–î–∞–≤–ª–µ–Ω–∏–µ',
          'reactive_power': '–†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å',
          'signal_strength': '–°–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞',
          'speed': '–°–∫–æ—Ä–æ—Å—Ç—å',
          'temperature': '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
          'volatile_organic_compounds': '–õ–û–°',
          'voltage': '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ',
          'volume': '–û–±—ä–µ–º',
          'water': '–í–æ–¥–∞',
          'weight': '–í–µ—Å',
          'wind_speed': '–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞'
        } %}
        {% set report_title = class_labels[target_class] | default(target_class) %}
        
        üìä <b>–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –û—Ç—á–µ—Ç –ø–æ {{ report_title }}</b>
        
        –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –≤—Å–µ—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ (–ö–ª–∞—Å—Å: {{ report_title }})
        {% set excluded_ids = exclude_input.entity_id | default([]) | flatten %}
        {% set report_lines = namespace(output=[]) %}
        
        {%- for sensor in states.sensor 
              | selectattr('attributes.device_class', 'eq', target_class) 
              | selectattr('state', '!=', none) 
              | sort(attribute='name') -%}
              
          {%- set unit = sensor.attributes.unit_of_measurement | default('N/A') -%}
          {%- set sensor_is_excluded = sensor.entity_id in excluded_ids -%}
          
          {%- if sensor.state != 'unknown' and sensor.state != 'unavailable' and sensor_is_excluded == false -%}
            {%- set state = sensor.state -%}
            {%- set name = sensor.name -%}
            
            {%- set report_lines.output = report_lines.output + [ name ~ ": " ~ state | round(2) ~ " " ~ unit ] -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- if report_lines.output | length > 0 -%}
        
        {{ report_lines.output | join('\n') }}
        
        {%- else -%}
        
        (–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º {{ report_title }}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ –Ω–∞–ª–∏—á–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è.)
        
        {%- endif -%}
        
      parse_mode: html
