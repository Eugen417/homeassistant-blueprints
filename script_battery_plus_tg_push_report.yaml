blueprint:
  name: "\U0001FAAB Скрипт отчета по батареям (v1.0.1)"
  description: 'Версия скрипта для отчета о состоянии батарей (на основе v3.8.1).


    Создает отчеты ("Замена", "Зарядка" и "Полный") и отправляет их в Telegram (HTML)
    или App.

    В полный отчет включены устройства, потерявшие связь (Unavailable).


    **Требование:** Интеграция HA-Battery Notes.

    '
  domain: script
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/script_battery_plus_tg_push_report.yaml
  input:
    mobile_notify_target:
      name: "\U0001F4F1 Мобильное устройство"
      description: Выберите устройство для push-уведомлений. Оставьте пустым, если
        не нужно.
      default: ''
      selector:
        device:
          integration: mobile_app
          multiple: false
    telegram_notify_target:
      name: "\U0001F4AC Telegram"
      description: Выберите сущности notify.telegram_bot_.... Оставьте пустым, если
        не нужно.
      default:
        entity_id: []
      selector:
        target:
          entity:
          - domain:
            - notify
    send_full_report_option:
      name: "\U0001F4CA Отправлять Полный отчет?"
      description: Включите для отправки полного списка (вторым сообщением в Telegram).
      default: false
      selector:
        boolean: {}
    critical_level:
      name: ⚠️ Критический уровень (%)
      description: Порог заряда для уведомлений о замене/зарядке.
      default: 15
      selector:
        number:
          min: 1.0
          max: 99.0
          step: 1.0
          unit_of_measurement: '%'
          mode: box
    excluded_sensors:
      name: "\U0001F5D1️ Исключаемые сенсоры"
      description: Сенсоры, которые нужно игнорировать.
      default:
        entity_id: []
      selector:
        target:
          entity:
          - domain:
            - sensor
            device_class:
            - battery
    text_disposable_header:
      name: "\U0001F4DD Заголовок (Замена)"
      default: '⚠️ <b>Устройства, требующие замены батареи:</b>

        '
      selector:
        text:
          multiple: false
          multiline: false
    text_disposable_action:
      name: "\U0001F4DD Шаблон строки (Замена)"
      default: '<b>%LEVEL%%</b> ♻️ ЗАМЕНА! (Тип: %TYPE%, Кол-во: %QTY%)'
      selector:
        text:
          multiple: false
          multiline: false
    text_disposable_ok:
      name: "\U0001F4DD Сообщение (Замена не требуется)"
      default: 'Все незаряжаемые батареи имеют заряд выше '
      selector:
        text:
          multiple: false
          multiline: false
    text_rechargeable_header:
      name: "\U0001F4DD Заголовок (Зарядка)"
      default: '⚠️ <b>Устройства, требующие подзарядки:</b>

        '
      selector:
        text:
          multiple: false
          multiline: false
    text_rechargeable_action:
      name: "\U0001F4DD Шаблон строки (Зарядка)"
      default: "<b>%LEVEL%%</b> \U0001F50C ЗАРЯДКА!"
      selector:
        text:
          multiple: false
          multiline: false
    text_rechargeable_ok:
      name: "\U0001F4DD Сообщение (Зарядка не требуется)"
      default: 'Все заряжаемые устройства имеют заряд выше '
      selector:
        text:
          multiple: false
          multiline: false
    text_full_replace_label:
      name: "\U0001F4DD Метка замены (Полный отчет)"
      default: ' ♻️ <b>ЗАМЕНА!</b>'
      selector:
        text:
          multiple: false
          multiline: false
    text_full_charge_label:
      name: "\U0001F4DD Метка зарядки (Полный отчет)"
      default: " \U0001F50C <b>ЗАРЯДКА!</b>"
      selector:
        text:
          multiple: false
          multiline: false
    text_rechargeable_type:
      name: "\U0001F4DD Название встроенного АКБ"
      default: Встроеный АКБ
      selector:
        text:
          multiple: false
          multiline: false
    text_unknown_type:
      name: "\U0001F4DD Название неизвестного типа"
      default: Неизвестный Тип
      selector:
        text:
          multiple: false
          multiline: false
    text_summary_header:
      name: "\U0001F4DD Заголовок сводки"
      default: "--- \n\n\U0001F50B <b>Сводка по Типу Батареи:</b>\n"
      selector:
        text:
          multiple: false
          multiline: false
    text_grand_total:
      name: "\U0001F4DD Шаблон общего количества"
      default: <i>Общее количество контролируемых элементов:</i> <b>%TOTAL%</b> шт.
      selector:
        text:
          multiple: false
          multiline: false
    text_offline_header:
      name: "\U0001F4DD Заголовок (Offline)"
      default: '⚠️ <b>ВНИМАНИЕ: Устройства без связи (Unavailable/Unknown):</b>'
      selector:
        text:
          multiple: false
          multiline: false
    text_no_sensors:
      name: "\U0001F4DD Сообщение нет сенсоров"
      default: Сенсоры батарей не найдены.
      selector:
        text:
          multiple: false
          multiline: false
    text_no_summary_data:
      name: "\U0001F4DD Сообщение нет сводки"
      default: Нет данных о типах батарей для отчета.
      selector:
        text:
          multiple: false
          multiline: false
    title_short_replace_low:
      name: "\U0001F4F1 Заголовок App (Замена, Низкий)"
      default: "\U0001F50B Батарея+: \U0001FAAB♻️ Заряд &lt; "
      selector:
        text:
          multiple: false
          multiline: false
    title_short_replace_ok:
      name: "\U0001F4F1 Заголовок App (Замена, OK)"
      default: "\U0001F50B Батарея+: Замена не требуется"
      selector:
        text:
          multiple: false
          multiline: false
    title_short_charge_low:
      name: "\U0001F4F1 Заголовок App (Зарядка, Низкий)"
      default: "\U0001F50B Батарея+: \U0001FAAB\U0001F50C Заряд &lt; "
      selector:
        text:
          multiple: false
          multiline: false
    title_short_charge_ok:
      name: "\U0001F4F1 Заголовок App (Зарядка, OK)"
      default: "\U0001F50B Батарея+: Зарядка не требуется"
      selector:
        text:
          multiple: false
          multiline: false
    title_full_report:
      name: "\U0001F4CA Заголовок (Полный отчет)"
      default: "\U0001F50B <b>Полный отчет Батарея+ (Сортировка по уровню):</b>"
      selector:
        text:
          multiple: false
          multiline: false
variables:
  mobile_device_id: !input mobile_notify_target
  telegram_notify_entities: !input telegram_notify_target
  critical_threshold: !input critical_level
  excluded_entity_ids: !input excluded_sensors
  send_full_report: !input send_full_report_option
  text_disposable_header: !input text_disposable_header
  text_disposable_action: !input text_disposable_action
  text_disposable_ok: !input text_disposable_ok
  text_rechargeable_header: !input text_rechargeable_header
  text_rechargeable_action: !input text_rechargeable_action
  text_rechargeable_ok: !input text_rechargeable_ok
  text_full_replace_label: !input text_full_replace_label
  text_full_charge_label: !input text_full_charge_label
  text_rechargeable_type: !input text_rechargeable_type
  text_unknown_type: !input text_unknown_type
  text_summary_header: !input text_summary_header
  text_grand_total: !input text_grand_total
  text_offline_header: !input text_offline_header
  text_no_sensors: !input text_no_sensors
  text_no_summary_data: !input text_no_summary_data
  title_short_replace_low: !input title_short_replace_low
  title_short_replace_ok: !input title_short_replace_ok
  title_short_charge_low: !input title_short_charge_low
  title_short_charge_ok: !input title_short_charge_ok
  title_full_report: !input title_full_report
sequence:
- alias: Рассчитать отчеты
  variables:
    threshold: '{{ critical_threshold | int }}'
    exclude_list: '{{ excluded_entity_ids.entity_id | default([]) }}'
    disposable_message: "{% set ns = namespace(disposable_lines=[]) %} {% for sensor
      in states.sensor %}\n  {% if sensor.attributes.battery_last_reported_level is
      defined and sensor.entity_id not in exclude_list %}\n    {% set name = sensor.attributes.friendly_name
      | default(sensor.entity_id) %}\n    {% set numerical_level = sensor.attributes.battery_last_reported_level
      | float(default=-1) | int(default=-1) %}\n    {% if numerical_level >= 0 and
      numerical_level < threshold %}\n      {% set battery_type = sensor.attributes.battery_type
      | default('Unknown') %}\n      {% set cleaned_name = name | replace(' Батарея+',
      '') | trim %} \n      {% set is_rechargeable = (battery_type == 'Rechargeable'
      or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name)
      %}\n      {% if not is_rechargeable %}\n        {% set battery_quantity = sensor.attributes.battery_quantity
      | default('1') | string %}\n        {% set escaped_battery_type = battery_type
      | string | replace('<', '&lt;') | replace('>', '&gt;') %}\n        {% set escaped_name
      = cleaned_name | string | replace('<', '&lt;') | replace('>', '&gt;') %}\n        {%
      set escaped_quantity = battery_quantity | replace('<', '&lt;') | replace('>',
      '&gt;') %}\n        {% set line_action = text_disposable_action | replace('%LEVEL%',
      numerical_level | string) | replace('%TYPE%', escaped_battery_type) | replace('%QTY%',
      escaped_quantity) %}\n        {% set line = escaped_name ~ \": \" ~ line_action
      %}\n        {% set ns.disposable_lines = ns.disposable_lines + [{ 'level': numerical_level,
      'line': line }] %}\n      {% endif %}\n    {% endif %}\n  {% endif %}\n{% endfor
      %} {% set sorted_disposable = ns.disposable_lines | sort(attribute='level')
      %} {% set disposable_output = sorted_disposable | map(attribute='line') | list
      %} {% if disposable_output | length > 0 %}\n  {{ text_disposable_header ~ disposable_output
      | join('\\n') }}\n{% else %}\n  {{ text_disposable_ok ~ critical_threshold ~
      \"%.\" }}\n{% endif %}"
    rechargeable_message: "{% set ns = namespace(rechargeable_lines=[]) %} {% for
      sensor in states.sensor %}\n  {% if sensor.attributes.battery_last_reported_level
      is defined and sensor.entity_id not in exclude_list %}\n    {% set name = sensor.attributes.friendly_name
      | default(sensor.entity_id) %}\n    {% set numerical_level = sensor.attributes.battery_last_reported_level
      | float(default=-1) | int(default=-1) %}\n    {% if numerical_level >= 0 and
      numerical_level < threshold %}\n      {% set battery_type = sensor.attributes.battery_type
      | default('Unknown') %}\n      {% set cleaned_name = name | replace(' Батарея+',
      '') | trim %}\n      {% set is_rechargeable = (battery_type == 'Rechargeable'
      or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name)
      %}\n      {% if is_rechargeable %}\n        {% set escaped_name = cleaned_name
      | string | replace('<', '&lt;') | replace('>', '&gt;') %}\n        {% set line_action
      = text_rechargeable_action | replace('%LEVEL%', numerical_level | string) %}\n
      \       {% set line = escaped_name ~ \": \" ~ line_action %}\n        {% set
      ns.rechargeable_lines = ns.rechargeable_lines + [{ 'level': numerical_level,
      'line': line }] %}\n      {% endif %}\n    {% endif %}\n  {% endif %}\n{% endfor
      %} {% set sorted_rechargeable = ns.rechargeable_lines | sort(attribute='level')
      %} {% set rechargeable_output = sorted_rechargeable | map(attribute='line')
      | list %} {% if rechargeable_output | length > 0 %}\n  {{ text_rechargeable_header
      ~ rechargeable_output | join('\\n') }}\n{% else %}\n  {{ text_rechargeable_ok
      ~ critical_threshold ~ \"%.\" }}\n{% endif %}"
    full_report_body_list: "{% set ns = namespace(all_lines=[]) %} {% set yellow_boundary
      = 40 %} {% set red_boundary = 15 %} {% for sensor in states.sensor %}\n  {%
      if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id
      not in exclude_list %}\n    {% set name = sensor.attributes.friendly_name |
      default(sensor.entity_id) %}\n    {% set numerical_level = sensor.attributes.battery_last_reported_level
      | float(default=-1) | int(default=-1) %}\n    {% if numerical_level >= 0 %}\n
      \     {% set battery_type = sensor.attributes.battery_type | default('Unknown')
      %}\n      {% set cleaned_name = name | replace(' Батарея+', '') | trim %} \n
      \     {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in
      cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}\n      {%
      set status_icon = '\U0001F7E2' %} \n      {% if numerical_level < red_boundary
      %} {% set status_icon = '\U0001F534' %}\n      {% elif numerical_level < yellow_boundary
      %} {% set status_icon = '\U0001F7E1' %}\n      {% endif %}\n      {% set status_label
      = '' %}\n      {% if numerical_level < threshold %}\n        {% set status_label
      = text_full_replace_label if not is_rechargeable else text_full_charge_label
      %}\n      {% endif %}\n      {% set details = \"\" %}\n      {% if not is_rechargeable
      %}\n        {% set battery_quantity = sensor.attributes.battery_quantity | default('1')
      | string %}\n        {% set escaped_battery_type = battery_type | string | replace('<',
      '&lt;') | replace('>', '&gt;') %}\n        {% set escaped_quantity = battery_quantity
      | replace('<', '&lt;') | replace('>', '&gt;') %}\n        {% set details = \"
      (Тип: \" ~ escaped_battery_type ~ \", Кол-во: \" ~ escaped_quantity ~ \" шт)\"
      %}\n      {% endif %}\n      {% set escaped_name = cleaned_name | string | replace('<',
      '&lt;') | replace('>', '&gt;') %}\n      {% set line = status_icon ~ \" \" ~
      escaped_name ~ \": \" ~ numerical_level ~ \"%\" ~ status_label ~ details %}\n
      \     {% set ns.all_lines = ns.all_lines + [{ 'level': numerical_level, 'line':
      line }] %}\n    {% endif %}\n  {% endif %}\n{% endfor %} {% set sorted_all =
      ns.all_lines | sort(attribute='level', reverse=true) %} {% set all_output =
      sorted_all | map(attribute='line') | list %} {% if all_output | length > 0 %}\n
      \ {{ all_output | join('\\n') }}\n{% else %}\n  {{ text_no_sensors }}\n{% endif
      %}"
    battery_types_summary: "{% set ns = namespace(output_lines=[]) %} {% set all_battery_sensors
      = states.sensor | selectattr('attributes.battery_last_reported_level', 'defined')
      | rejectattr('entity_id', 'in', exclude_list) | list %} {% set grouped_by_type
      = all_battery_sensors | groupby('attributes.battery_type') %} {% for type, sensors
      in grouped_by_type %}\n  {% set total_quantity = namespace(value=0) %}\n  {%
      for sensor in sensors %}\n    {% set quantity = sensor.attributes.battery_quantity
      | default('1') | int(default=1) %}\n    {% set total_quantity.value = total_quantity.value
      + quantity %}\n  {% endfor %}\n  {% set display_type = type | default(text_unknown_type)
      | string %}\n  {% if display_type == 'Rechargeable' %} {% set display_type =
      text_rechargeable_type %} {% endif %}\n  {% set escaped_display_type = display_type
      | replace('<', '&lt;') | replace('>', '&gt;') %}\n  {% set line = \"• \" ~ escaped_display_type
      ~ \" (Всего: \" ~ total_quantity.value ~ \" шт)\" %}\n  {% set ns.output_lines
      = ns.output_lines + [line] %}\n{% endfor %} {% if ns.output_lines | length >
      0 %}\n  {{ text_summary_header ~ ns.output_lines | sort | join('\\n') }}\n{%
      else %}\n  {{ text_no_summary_data }}\n{% endif %}"
    offline_sensors_report: "{% set ns = namespace(offline_lines=[]) %} {% for sensor
      in states.sensor %}\n  {% if sensor.attributes.battery_last_reported_level is
      defined and sensor.entity_id not in exclude_list %}\n    {% if sensor.state
      in ['unavailable', 'unknown'] %}\n      {% set name = sensor.attributes.friendly_name
      | default(sensor.entity_id) %}\n      {% set cleaned_name = name | replace('
      Батарея+', '') | trim %}\n      {% set escaped_name = cleaned_name | string
      | replace('<', '&lt;') | replace('>', '&gt;') %}\n      {% set line = \"❓ \"
      ~ escaped_name ~ \" (Статус: \" ~ sensor.state ~ \")\" %}\n      {% set ns.offline_lines
      = ns.offline_lines + [line] %}\n    {% endif %}\n  {% endif %}\n{% endfor %}
      {% if ns.offline_lines | length > 0 %}\n  {{ text_offline_header ~ '\\n' ~ ns.offline_lines
      | join('\\n') }}\n{% endif %}"
    grand_total_quantity: "{% set total = namespace(value=0) %} {% set exclude_list_local
      = excluded_entity_ids.entity_id | default([]) %} {% for sensor in states.sensor
      %}\n  {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id
      not in exclude_list_local %}\n    {% set quantity = sensor.attributes.battery_quantity
      | default('1') | int(default=1) %}\n    {% set total.value = total.value + quantity
      %}\n  {% endif %}\n{% endfor %} {{ total.value }}"
    full_report_message: '{% set total_text = text_grand_total | replace(''%TOTAL%'',
      grand_total_quantity | default(0) | string) %} {% set header = title_full_report
      %} {{ header ~ ''\n'' ~ total_text ~ ''\n\n'' ~ full_report_body_list ~ ''\n\n''
      ~ battery_types_summary ~ ''\n\n'' ~ offline_sensors_report }}

      '
- alias: Send Mobile Notification
  choose:
  - conditions:
    - condition: template
      value_template: '{{ mobile_device_id is not none and mobile_device_id != ''''
        }}'
    sequence:
    - service: notify.mobile_app_{{ device_attr(mobile_device_id, 'name') | lower
        | replace(' ', '_') | replace('-', '_') }}
      data:
        title: "{% if disposable_message.startswith('⚠️') or rechargeable_message.startswith('⚠️')
          %}\n  {{ title_short_replace_low ~ critical_threshold ~ \"%\" }}\n{% else
          %}\n  {{ title_short_replace_ok }}\n{% endif %}\n"
        message: '{{ disposable_message | striptags }}


          {{ rechargeable_message | striptags }}'
- alias: Prepare Telegram Target IDs
  variables:
    target_chat_ids: "{% set selected_entities_raw = telegram_notify_entities.entity_id
      | default([]) %} {% set selected_entities = [selected_entities_raw] | flatten
      %} {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_',
      replace='') | list %} {% set ns = namespace(target_ids=[]) %} {% for id_string
      in chat_id_strings %}\n  {% set cleaned_id = id_string | string | trim %}\n
      \ {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}\n    {%
      set ns.target_ids = ns.target_ids + ['-' ~ cleaned_id] %}\n  {% else %}\n    {%
      set ns.target_ids = ns.target_ids + [cleaned_id] %}\n  {% endif %}\n{% endfor
      %} {{ ns.target_ids }}"
- alias: Send Telegram Messages
  choose:
  - conditions:
    - condition: template
      value_template: '{{ target_chat_ids | length > 0 }}'
    sequence:
    - service: telegram_bot.send_message
      data:
        target: '{{ target_chat_ids }}'
        message: "{% set report_body = disposable_message %}\n{% if report_body.startswith('⚠️')
          %}\n  {% set header = '<b>' ~ title_short_replace_low ~ critical_threshold
          ~ '%</b>' %}\n{% else %}\n  {% set header = '<b>' ~ title_short_replace_ok
          ~ '</b>' %}\n{% endif %}\n{{ header ~ \"\\n\\n\" ~ report_body }}\n"
        parse_mode: html
    - service: telegram_bot.send_message
      data:
        target: '{{ target_chat_ids }}'
        message: "{% set report_body = rechargeable_message %}\n{% if report_body.startswith('⚠️')
          %}\n  {% set header = '<b>' ~ title_short_charge_low ~ critical_threshold
          ~ '%</b>' %}\n{% else %}\n  {% set header = '<b>' ~ title_short_charge_ok
          ~ '</b>' %}\n{% endif %}\n{{ header ~ \"\\n\\n\" ~ report_body }}\n"
        parse_mode: html
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ send_full_report }}'
        sequence:
        - service: telegram_bot.send_message
          data:
            target: '{{ target_chat_ids }}'
            message: '{{ full_report_message }}'
            parse_mode: html
mode: single
