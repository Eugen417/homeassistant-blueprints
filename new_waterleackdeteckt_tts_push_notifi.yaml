blueprint:
  name: üíß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ—Ç–µ—á–∫–µ v15.9 (Final Stable)
  description: >-
    –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–º
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/new_waterleackdeteckt_tts_push_notifi.yaml
  
  input:
    zone_1_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 1
      default: '–ö—É—Ö–Ω—è'
      selector:
        text:
    leak_sensors_zone_1:
      name: –î–∞—Ç—á–∏–∫–∏ –ó–æ–Ω—ã 1
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_1:
      name: –ö—Ä–∞–Ω—ã –ó–æ–Ω—ã 1
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_2_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 2
      default: '–í–∞–Ω–Ω–∞—è'
      selector:
        text:
    leak_sensors_zone_2:
      name: –î–∞—Ç—á–∏–∫–∏ –ó–æ–Ω—ã 2
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_2:
      name: –ö—Ä–∞–Ω—ã –ó–æ–Ω—ã 2
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_3_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 3
      default: '–î—É—à–µ–≤–∞—è'
      selector:
        text:
    leak_sensors_zone_3:
      name: –î–∞—Ç—á–∏–∫–∏ –ó–æ–Ω—ã 3
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_3:
      name: –ö—Ä–∞–Ω—ã –ó–æ–Ω—ã 3
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    zone_4_name:
      name: –ù–∞–∑–≤–∞–Ω–∏–µ –ó–æ–Ω—ã 4
      default: '–û—Ç–æ–ø–ª–µ–Ω–∏–µ'
      selector:
        text:
    leak_sensors_zone_4:
      name: –î–∞—Ç—á–∏–∫–∏ –ó–æ–Ω—ã 4
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
          multiple: true
      default: []
    water_shutoff_devices_zone_4:
      name: –ö—Ä–∞–Ω—ã –ó–æ–Ω—ã 4
      selector:
        entity:
          domain: switch
          multiple: true
      default: []
    notify_device:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è PUSH
      selector:
        device:
          integration: mobile_app
    telegram_notify_target:
      name: Telegram Notify Entity
      description: "–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏: notify.telegram_bot_..."
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify
    notification_title:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫
      default: 'üíß –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ü–†–û–¢–ï–ß–ö–ê!'
      selector:
        text:
    tts_media_players:
      name: –ú–µ–¥–∏–∞–ø–ª–µ–µ—Ä—ã TTS
      selector:
        entity:
          domain: media_player
          multiple: true
      default: []
    tts_service:
      name: –°–µ—Ä–≤–∏—Å TTS
      default: tts.yandex_station_say
      selector:
        text:
    tts_volume:
      name: –ì—Ä–æ–º–∫–æ—Å—Ç—å TTS
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          mode: slider
      default: 0.7
    tts_delay_after_leak_message:
      name: –ó–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–∞–Ω–æ–≤ (—Å–µ–∫)
      description: –í—Ä–µ–º—è –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –ø—Ä–æ—Ç–µ—á–∫–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π, –∑–∞–∫—Ä—ã–ª–∏—Å—å –ª–∏ –∫—Ä–∞–Ω—ã.
      selector:
        number:
          min: 0
          max: 60
          step: 1
          mode: slider
      default: 11
    tts_delay_between_runs:
      name: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
      selector:
        number:
          min: 0
          max: 60
          step: 1
          mode: slider
      default: 5

variables:
  telegram_input: !input telegram_notify_target
  notif_title: !input notification_title
  # === –õ–û–ì–ò–ö–ê –ò–ó –°–ö–†–ò–ü–¢–ê BATTERY REPORT (–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ) ===
  target_chat_ids: >
    {% set selected_entities_raw = telegram_input.entity_id | default([]) %} 
    {% set selected_entities = [selected_entities_raw] | flatten %} 
    {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %} 
    {% set ns = namespace(target_ids=[]) %} 
    {% for id_string in chat_id_strings %}
      {% set cleaned_id = id_string | string | trim %}
      {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
        {% set id_with_hyphen = '-' ~ cleaned_id %}
        {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
      {% else %}
        {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
      {% endif %}
    {% endfor %} 
    {{ ns.target_ids }}

trigger:
  - platform: state
    entity_id: !input 'leak_sensors_zone_1'
    to: 'on'
    alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –ø–µ—Ä–≤–æ–π –∑–æ–Ω–µ
  - platform: state
    entity_id: !input 'leak_sensors_zone_2'
    to: 'on'
    alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–π –∑–æ–Ω–µ
  - platform: state
    entity_id: !input 'leak_sensors_zone_3'
    to: 'on'
    alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω–µ
  - platform: state
    entity_id: !input 'leak_sensors_zone_4'
    to: 'on'
    alias: –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω–µ

condition:
  - condition: template
    value_template: "{{ trigger.to_state.state != 'unknown' }}"
  - condition: template
    value_template: "{{ trigger.from_state.state != 'unknown' }}"

action:
  - choose:
      # ================= –ó–û–ù–ê 1 =================
      - conditions: "{{ trigger.alias == '–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –ø–µ—Ä–≤–æ–π –∑–æ–Ω–µ' }}"
        sequence:
          - variables:
              zone: !input 'zone_1_name'
              valves: !input 'water_shutoff_devices_zone_1'
              # –û—á–∏—â–∞–µ–º –∏–º—è –¥–∞—Ç—á–∏–∫–∞ –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
              sensor_name: "{{ trigger.to_state.attributes.friendly_name | default(trigger.to_state.name) | replace(' water leak', '') | replace(' Water leak detected', '') | replace(' Water Leak', '') }}"
          
          # 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∞–Ω—ã
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ valves }}"
          
          # 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ PUSH (–°—Ä–∞–∑—É) - –ò–°–ü–†–ê–í–õ–ï–ù–û (–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ device)
          - if: "{{ notify_device is not none }}"
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                title: "{{ notif_title }}"
                message: "‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}. –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã."

          # 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Telegram (–°—Ä–∞–∑—É)
          - choose:
              - conditions: "{{ target_chat_ids | length > 0 }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: '{{ target_chat_ids }}'
                      message: "<b>{{ notif_title }}</b>\n‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}.\n{% if valves | length > 0 %}üö∞ –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã...{% endif %}"
                      parse_mode: html

          # 4. TTS (–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
          - service: media_player.volume_set
            target:
              entity_id: !input 'tts_media_players'
            data:
              volume_level: !input 'tts_volume'
          - service: !input 'tts_service'
            data:
              entity_id: !input 'tts_media_players'
              message: "–í–Ω–∏–º–∞–Ω–∏–µ! –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –∑–æ–Ω–µ {{ zone }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ sensor_name }}. –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã."

          # 5. –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫—Ä–∞–Ω–æ–≤
          - delay:
              seconds: !input 'tts_delay_after_leak_message'

          # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –≤—Ç–æ—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          - choose:
              # –°–¶–ï–ù–ê–†–ò–ô –ê: –í—Å–µ –∫—Ä–∞–Ω—ã –∑–∞–∫—Ä—ã—Ç—ã (–£–°–ü–ï–•)
              - conditions: "{{ valves | select('is_state', 'off') | list | length == valves | length }}"
                sequence:
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }}."
                  - choose:
                      - conditions: "{{ target_chat_ids | length > 0 }}"
                        sequence:
                          - service: telegram_bot.send_message
                            data:
                              target: '{{ target_chat_ids }}'
                              message: "<b>‚úÖ –£–°–ü–ï–®–ù–û:</b> –í—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }} –ø–µ—Ä–µ–∫—Ä—ã—Ç—ã."
                              parse_mode: html

              # –°–¶–ï–ù–ê–†–ò–ô –ë: –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö –∏–ª–∏ –ø—Ä–æ–≤–∞–ª (–µ—Å–ª–∏ –∫—Ä–∞–Ω—ã –µ—Å—Ç—å)
              - conditions: "{{ valves | length > 0 }}"
                sequence:
                  - variables:
                      failed: "{{ expand(valves) | selectattr('state','ne','off') | map(attribute='name') | list | join(', ') }}"
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }}."
                  - choose:
                      - conditions: "{{ target_chat_ids | length > 0 }}"
                        sequence:
                          - service: telegram_bot.send_message
                            data:
                              target: '{{ target_chat_ids }}'
                              message: "<b>üö® –û–®–ò–ë–ö–ê:</b> –ù–µ –∑–∞–∫—Ä—ã—Ç—ã –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }}: {{ failed }}"
                              parse_mode: html

      # ================= –ó–û–ù–ê 2 =================
      - conditions: "{{ trigger.alias == '–ü—Ä–æ—Ç–µ—á–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–π –∑–æ–Ω–µ' }}"
        sequence:
          - variables:
              zone: !input 'zone_2_name'
              valves: !input 'water_shutoff_devices_zone_2'
              sensor_name: "{{ trigger.to_state.attributes.friendly_name | default(trigger.to_state.name) | replace(' water leak', '') | replace(' Water leak detected', '') | replace(' Water Leak', '') }}"
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ valves }}"
          
          # PUSH FIX
          - if: "{{ notify_device is not none }}"
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                title: "{{ notif_title }}"
                message: "‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."

          - choose:
              - conditions: "{{ target_chat_ids | length > 0 }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: '{{ target_chat_ids }}'
                      message: "<b>{{ notif_title }}</b>\n‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."
                      parse_mode: html
          - service: media_player.volume_set
            target:
              entity_id: !input 'tts_media_players'
            data:
              volume_level: !input 'tts_volume'
          - service: !input 'tts_service'
            data:
              entity_id: !input 'tts_media_players'
              message: "–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –∑–æ–Ω–µ {{ zone }} –æ—Ç –¥–∞—Ç—á–∏–∫–∞ {{ sensor_name }}. –ó–∞–∫—Ä—ã–≤–∞—é –∫—Ä–∞–Ω—ã."
          - delay:
              seconds: !input 'tts_delay_after_leak_message'
          - choose:
              - conditions: "{{ valves | select('is_state', 'off') | list | length == valves | length }}"
                sequence:
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–Ø –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –≤—Å–µ –∫—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }}."
                  - choose:
                      - conditions: "{{ target_chat_ids | length > 0 }}"
                        sequence:
                          - service: telegram_bot.send_message
                            data:
                              target: '{{ target_chat_ids }}'
                              message: "<b>‚úÖ –£–°–ü–ï–®–ù–û:</b> –ö—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }} –∑–∞–∫—Ä—ã—Ç—ã."
                              parse_mode: html
              - conditions: "{{ valves | length > 0 }}"
                sequence:
                  - variables:
                      failed: "{{ expand(valves) | selectattr('state','ne','off') | map(attribute='name') | list | join(', ') }}"
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–í–Ω–∏–º–∞–Ω–∏–µ! –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫—Ä–∞–Ω–æ–≤ –≤ –∑–æ–Ω–µ {{ zone }}."
                  - choose:
                      - conditions: "{{ target_chat_ids | length > 0 }}"
                        sequence:
                          - service: telegram_bot.send_message
                            data:
                              target: '{{ target_chat_ids }}'
                              message: "<b>üö® –û–®–ò–ë–ö–ê:</b> –ù–µ –∑–∞–∫—Ä—ã—Ç—ã: {{ failed }}"
                              parse_mode: html

      # ================= –ó–û–ù–ê 3 =================
      - conditions: "{{ trigger.alias == '–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —Ç—Ä–µ—Ç—å–µ–π –∑–æ–Ω–µ' }}"
        sequence:
          - variables:
              zone: !input 'zone_3_name'
              valves: !input 'water_shutoff_devices_zone_3'
              sensor_name: "{{ trigger.to_state.attributes.friendly_name | default(trigger.to_state.name) | replace(' water leak', '') | replace(' Water leak detected', '') | replace(' Water Leak', '') }}"
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ valves }}"
          
          # PUSH FIX
          - if: "{{ notify_device is not none }}"
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                title: "{{ notif_title }}"
                message: "‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."

          - choose:
              - conditions: "{{ target_chat_ids | length > 0 }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: '{{ target_chat_ids }}'
                      message: "<b>{{ notif_title }}</b>\n‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."
                      parse_mode: html
          - service: !input 'tts_service'
            data:
              entity_id: !input 'tts_media_players'
              message: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞ –≤ –∑–æ–Ω–µ {{ zone }}."
          - delay:
              seconds: !input 'tts_delay_after_leak_message'
          - choose:
              - conditions: "{{ valves | select('is_state', 'off') | list | length == valves | length }}"
                sequence:
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–ö—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }} –∑–∞–∫—Ä—ã—Ç—ã."
              - conditions: "{{ valves | length > 0 }}"
                sequence:
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫—Ä–∞–Ω–æ–≤ –≤ –∑–æ–Ω–µ {{ zone }}."

      # ================= –ó–û–ù–ê 4 =================
      - conditions: "{{ trigger.alias == '–ü—Ä–æ—Ç–µ—á–∫–∞ –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –∑–æ–Ω–µ' }}"
        sequence:
          - variables:
              zone: !input 'zone_4_name'
              valves: !input 'water_shutoff_devices_zone_4'
              sensor_name: "{{ trigger.to_state.attributes.friendly_name | default(trigger.to_state.name) | replace(' water leak', '') | replace(' Water leak detected', '') | replace(' Water Leak', '') }}"
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ valves }}"
          
          # PUSH FIX
          - if: "{{ notify_device is not none }}"
            then:
              - domain: mobile_app
                type: notify
                device_id: !input notify_device
                title: "{{ notif_title }}"
                message: "‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."

          - choose:
              - conditions: "{{ target_chat_ids | length > 0 }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: '{{ target_chat_ids }}'
                      message: "<b>{{ notif_title }}</b>\n‚ö†Ô∏è –ó–æ–Ω–∞: {{ zone }}. –î–∞—Ç—á–∏–∫: {{ sensor_name }}."
                      parse_mode: html
          - service: !input 'tts_service'
            data:
              entity_id: !input 'tts_media_players'
              message: "–í–Ω–∏–º–∞–Ω–∏–µ! –ü—Ä–æ—Ç–µ—á–∫–∞ –≤ –∑–æ–Ω–µ {{ zone }}."
          - delay:
              seconds: !input 'tts_delay_after_leak_message'
          - choose:
              - conditions: "{{ valves | select('is_state', 'off') | list | length == valves | length }}"
                sequence:
                  - service: !input 'tts_service'
                    data:
                      entity_id: !input 'tts_media_players'
                      message: "–ö—Ä–∞–Ω—ã –≤ –∑–æ–Ω–µ {{ zone }} –ø–µ—Ä–µ–∫—Ä—ã—Ç—ã."

  - delay:
      seconds: !input 'tts_delay_between_runs'

mode: queued
max: 10
