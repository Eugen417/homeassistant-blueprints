blueprint:
  name: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ü—Ä–æ–≥–Ω–æ–∑ –æ –º–µ—Ç–∏–æ –æ—Å–∞–¥–∫–∞—Ö –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞—Ö v1.1"
  description: >
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Å–∞–¥–∫–æ–≤, —Å–æ–≤–µ—Ç—ã).
    –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π Telegram –∏–∑ —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π (–∫–∞–∫ –≤ –æ—Ç—á–µ—Ç–µ –ø–æ –±–∞—Ç–∞—Ä–µ—è–º).
  domain: automation
  
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/weather_smart_telegram.yaml
  
  input:
    # --- –ì–õ–ê–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ---
    weather_entity:
      name: "–ü–æ–≥–æ–¥–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å"
      description: –í–∞—à weather.yandex_pogoda –∏–ª–∏ OpenMeteo
      selector:
        entity:
          domain: weather
    
    trigger_time:
      name: "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏"
      description: –í–æ —Å–∫–æ–ª—å–∫–æ –±–æ—Ç –ø—Ä–∏—à–ª–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä 07:00)
      default: "07:00:00"
      selector:
        time: {}

    telegram_notify_target:
      name: "üí¨ –¶–µ–ª–µ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram"
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ Telegram (notify.telegram_...), —Å–∫—Ä–∏–ø—Ç —Å–∞–º –Ω–∞–π–¥–µ—Ç ID.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

    # --- –ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–ö–°–¢–û–í ---
    txt_rain:
      name: "–¢–µ–∫—Å—Ç: –î–æ–∂–¥—å"
      default: "–î–æ–∂–¥—å üåß"
    txt_pouring:
      name: "–¢–µ–∫—Å—Ç: –õ–∏–≤–µ–Ω—å"
      default: "–õ–∏–≤–µ–Ω—å ‚õà"
    txt_snow:
      name: "–¢–µ–∫—Å—Ç: –°–Ω–µ–≥"
      default: "–°–Ω–µ–≥ ‚ùÑÔ∏è"
    txt_snow_rain:
      name: "–¢–µ–∫—Å—Ç: –°–Ω–µ–≥ —Å –¥–æ–∂–¥–µ–º"
      default: "–°–Ω–µ–≥ —Å –¥–æ–∂–¥–µ–º üíß‚ùÑÔ∏è"
    txt_lightning:
      name: "–¢–µ–∫—Å—Ç: –ì—Ä–æ–∑–∞"
      default: "–ì—Ä–æ–∑–∞ ‚ö°Ô∏è"
    txt_hail:
      name: "–¢–µ–∫—Å—Ç: –ì—Ä–∞–¥"
      default: "–ì—Ä–∞–¥ üå®"
    
    # --- –°–û–í–ï–¢–´ ---
    txt_umbrella:
      name: "–°–æ–≤–µ—Ç: –í–∑—è—Ç—å –∑–æ–Ω—Ç"
      default: "‚òîÔ∏è <b>–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∑—è—Ç—å –∑–æ–Ω—Ç!</b>"
    txt_warm:
      name: "–°–æ–≤–µ—Ç: –û–¥–µ—Ç—å—Å—è —Ç–µ–ø–ª–µ–µ"
      default: "üß£ <b>–û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ!</b>"
    
    cold_threshold:
      name: "–ü–æ—Ä–æ–≥ —Å–∏–ª—å–Ω–æ–≥–æ –º–æ—Ä–æ–∑–∞ (¬∞C)"
      default: -15
      selector:
        number:
          min: -50
          max: 0
          unit_of_measurement: "¬∞C"
    
    txt_freeze_alert:
      name: "–°–æ–≤–µ—Ç: –°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑"
      default: "üß£ <b>–ù–∞ —É–ª–∏—Ü–µ —Å–µ—Ä—å–µ–∑–Ω—ã–π –º–∏–Ω—É—Å! –û–¥–µ–≤–∞–π—Ç–µ—Å—å –∫–∞–∫ –∫–∞–ø—É—Å—Ç–∞!</b>"
    txt_cool_alert:
      name: "–°–æ–≤–µ—Ç: –ü—Ä–æ—Ö–ª–∞–¥–Ω–æ"
      default: "üß• <b>–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ —à–∞–ø–∫—É.</b>"
    txt_good_day:
      name: "–¢–µ–∫—Å—Ç: –•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å"
      default: "–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"

variables:
  weather_entity: !input weather_entity
  telegram_notify_target: !input telegram_notify_target
  
  # --- –õ–û–ì–ò–ö–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID ---
  target_chat_ids: >-
    {% set selected_entities_raw = telegram_notify_target.entity_id | default([]) %}
    {% set selected_entities = [selected_entities_raw] | flatten %}
    {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
    {% set ns = namespace(target_ids=[]) %}
    {% for id_string in chat_id_strings %}
      {% set cleaned_id = id_string | string | trim %}
      {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
        {% set id_with_hyphen = '-' ~ cleaned_id %}
        {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
      {% else %}
        {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
      {% endif %}
    {% endfor %}
    {{ ns.target_ids }}

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤
  t_rain: !input txt_rain
  t_pouring: !input txt_pouring
  t_snow: !input txt_snow
  t_snow_rain: !input txt_snow_rain
  t_lightning: !input txt_lightning
  t_hail: !input txt_hail
  
  adv_umbrella: !input txt_umbrella
  adv_warm: !input txt_warm
  adv_freeze: !input txt_freeze_alert
  adv_cool: !input txt_cool_alert
  adv_good: !input txt_good_day
  limit_cold: !input cold_threshold

trigger:
  - platform: time
    at: !input trigger_time

action:
  - if:
      - condition: template
        value_template: "{{ target_chat_ids | length == 0 }}"
    then:
      - stop: "–ù–µ –≤—ã–±—Ä–∞–Ω—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ Telegram"

  - action: weather.get_forecasts
    target:
      entity_id: !input weather_entity
    data:
      type: hourly
    response_variable: daily_weather_data

  - if:
      - condition: template
        value_template: >
          {% set forecast = daily_weather_data[weather_entity].forecast %}
          {% set bad_weather = ['rainy', 'pouring', 'lightning-rainy', 'snowy-rainy', 'snowy', 'hail'] %}
          {{ forecast[:24] | selectattr('condition', 'in', bad_weather) | list | count > 0 }}
    
    # === –í–ï–¢–ö–ê 1: –û–°–ê–î–ö–ò –ï–°–¢–¨ ===
    then:
      - action: telegram_bot.send_message
        metadata: {}
        data:
          target: "{{ target_chat_ids }}"
          parse_mode: html
          title: "üå® –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã"
          message: >
            {%- set forecast = daily_weather_data[weather_entity].forecast -%}
            {%- set bad_weather = ['rainy', 'pouring', 'lightning-rainy', 'snowy-rainy', 'snowy', 'hail'] -%}
            {%- set wet_weather = ['rainy', 'pouring', 'lightning-rainy', 'snowy-rainy'] -%}
            {%- set mapper = {
              'rainy': t_rain, 'pouring': t_pouring, 'lightning-rainy': t_lightning,
              'snowy-rainy': t_snow_rain, 'snowy': t_snow, 'hail': t_hail
            } -%}
            
            <b>–í–Ω–∏–º–∞–Ω–∏–µ, –æ–∂–∏–¥–∞—é—Ç—Å—è –æ—Å–∞–¥–∫–∏ (24—á):</b>
            {%- set ns = namespace(blocks=[], current_block=[]) -%}
            {%- for hour in forecast[:24] if hour.condition in bad_weather -%}
              {%- set prev = ns.current_block[-1] if ns.current_block else none -%}
              {%- if prev and (as_timestamp(hour.datetime) - as_timestamp(prev.datetime)) == 3600 -%}
                {%- set ns.current_block = ns.current_block + [hour] -%}
              {%- else -%}
                {%- if ns.current_block -%}
                  {%- set ns.blocks = ns.blocks + [ns.current_block] -%}
                {%- endif -%}
                {%- set ns.current_block = [hour] -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if ns.current_block -%}
              {%- set ns.blocks = ns.blocks + [ns.current_block] -%}
            {%- endif -%}
            
            {%- for block in ns.blocks -%}
              {%- set start = block[0] -%}
              {%- set end = block[-1] -%}
              {%- set c_name = mapper[start.condition] if start.condition in mapper else start.condition -%}
              {%- if start == end -%}
            {{'\n'}}üïí <b>{{ as_timestamp(start.datetime) | timestamp_custom('%H:%M') }}</b> ‚Äî {{ c_name }} ({{ start.temperature }}¬∞C)
              {%- else -%}
                {%- set end_time = as_timestamp(end.datetime) + 3600 -%}
            {{'\n'}}üïí <b>{{ as_timestamp(start.datetime) | timestamp_custom('%H:%M') }}‚Äì{{ end_time | timestamp_custom('%H:%M') }}</b> ‚Äî {{ c_name }} ({{ start.temperature }}¬∞C)
              {%- endif -%}
            {%- endfor -%}
            
            {{'\n\n'}}
            {%- set has_rain = forecast[:24] | selectattr('condition', 'in', wet_weather) | list | count > 0 -%}
            {%- if has_rain -%}
            {{ adv_umbrella }}
            {%- else -%}
            {{ adv_warm }}
            {%- endif -%}

    # === –í–ï–¢–ö–ê 2: –û–°–ê–î–ö–û–í –ù–ï–¢ ===
    else:
      - action: telegram_bot.send_message
        metadata: {}
        data:
          target: "{{ target_chat_ids }}"
          parse_mode: html
          title: >
            {% set t = daily_weather_data[weather_entity].forecast[0].temperature %}
            {% if t < limit_cold %} ü•∂ –ë—Ä—Ä—Ä, –¥—É–±–∞–∫!
            {% elif t < 0 %} ‚ùÑÔ∏è –ú–æ—Ä–æ–∑–Ω–æ
            {% else %} ‚òÄÔ∏è –•–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞
            {% endif %}
          message: >
            {%- set current = daily_weather_data[weather_entity].forecast[0] -%}
            –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!
            {{'\n'}}–û—Å–∞–¥–∫–æ–≤ –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è{% if current.temperature < 0 %}, –Ω–æ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≥—Ä–∞–¥—É—Å–Ω–∏–∫.{% else %}.{% endif %}
            –°–µ–π—á–∞—Å –Ω–∞ —É–ª–∏—Ü–µ: <b>{{ current.temperature }}¬∞C</b>.
            
            {%- if current.temperature < limit_cold -%}
            {{ adv_freeze }}
            {%- elif current.temperature < -5 -%}
            {{ adv_cool }}
            {%- else -%}
            {{ adv_good }}
            {%- endif -%}
