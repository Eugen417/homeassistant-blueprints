id: homeassistant_person_tracker_telegram_v1.5
blueprint:
  name: üè† –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –∏ Telegram üìç
  description: |
    –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∞/—É—Ö–æ–¥–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (person.XXX) —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
    –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è. **–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å
    –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.**
    
    ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (`mode: parallel`) –∏ –∑–∞–ø—Ä–æ—Å–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
    **–≤—Å–µ—Ö** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`/gde_vse`).
    
    –¢–†–ï–ë–û–í–ê–ù–ò–ï: –î–ª—è Telegram-–∫–Ω–æ–ø–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º `platform: polling` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞.

    ---
    **–ü–†–ò–ú–ï–† –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò TELEGRAM –í configuration.yaml** ü§ñ
    ---
    telegram_bot:
      - platform: polling 
        api_key: "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
        parse_mode: html
        allowed_chat_ids:
          - -1234567890123 
          - 987654321 
        allowed_commands:
          - /gde_vse 
        
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/person_tracker_RU.yaml
        
  domain: automation
  input:
    # 1. –°–ü–ò–°–û–ö –û–¢–°–õ–ï–ñ–ò–í–ê–ï–ú–´–• PERSON
    tracked_persons:
      name: üìù –°–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (person.XXX) üó∫Ô∏è 
      description: –í—ã–±–µ—Ä–∏—Ç–µ person-—Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è.
      selector:
        entity:
          domain: person
          multiple: true
          
    # 2. –°–ï–†–í–ò–° –£–í–ï–î–û–ú–õ–ï–ù–ò–ô TELEGRAM
    telegram_notifications:
      name: ‚û§ –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Telegram (notify.xxx) üó∫Ô∏è 
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å notify, —Å–æ–∑–¥–∞–Ω–Ω—É—é –¥–ª—è Telegram-–±–æ—Ç–∞.
      selector:
        entity:
          domain: notify
          integration: telegram_bot
          
    # --- –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –§–†–ê–ó–´ ---
    message_left_home:
      name: üö∂ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Ö–æ–¥–µ
      description: –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–¥–∞–µ—Ç –∑–æ–Ω—É 'home'.
      default: "{name} –≤—ã—à–µ–ª –∏–∑ –∫–≤–∞—Ä—Ç–∏—Ä—ã üö™"
      selector:
        text:
    
    message_returned_home:
      name: üè° –°–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏
      description: –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∑–æ–Ω—É 'home'.
      default: "{name} –≤–µ—Ä–Ω—É–ª—Å—è –¥–æ–º–æ–π! üëã"
      selector:
        text:
        
    button_text_where_now:
      name: üó∫Ô∏è –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ (–æ–¥–∏–Ω —á–µ–ª.)
      description: –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.
      default: "–ì–¥–µ —Å–µ–π—á–∞—Å {name}? üó∫Ô∏è"
      selector:
        text:
        
    button_text_show_all:
      name: üåê –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ (–≤—Å–µ)
      description: –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
      default: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö üåê"
      selector:
        text:

    message_request_all:
      name: ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ—Ö
      description: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ü–∏–∫–ª–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
      default: "‚úÖ –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤—Å–µ—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ({count} —á–µ–ª.) –æ—Ç {sender}:"
      selector:
        text:

    message_location_unknown:
      name: ‚ùì –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
      description: –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
      default: "‚ö†Ô∏è –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ {name} —Å–µ–π—á–∞—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ. ‚ùì"
      selector:
        text:
        
    message_home_status:
      name: üè† –§—Ä–∞–∑–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–¥–æ–º–∞"
      description: –§—Ä–∞–∑–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è 'home'.
      default: "–¥–æ–º–∞! üè°"
      selector:
        text:

trigger:
  # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —É—Ö–æ–¥–∞/–ø—Ä–∏—Ö–æ–¥–∞
  - platform: state
    entity_id: !input tracked_persons
    to: 'not_home'
  - platform: state
    entity_id: !input tracked_persons
    to: 'home'
  
  # –¢—Ä–∏–≥–≥–µ—Ä 3: –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–∂–∞—Ç–∏–µ inline-–∫–Ω–æ–ø–∫–∏)
  - id: location_request
    platform: event
    event_type: telegram_callback
    
  # –¢–†–ò–ì–ì–ï–† 4: –ö–æ–º–∞–Ω–¥–∞, –≤–≤–µ–¥–µ–Ω–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, /gde_vse)
  - id: command_request
    platform: event
    event_type: telegram_command

action:
  # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-ID –∏–∑ input –∏ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ò–ó–í–õ–ï–ö–ê–ï–ú ID —á–∞—Ç–∞
  - variables:
      telegram_notifications_id: !input telegram_notifications
      tracked_persons_ids: !input tracked_persons
      all_command: "/gde_vse" # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ—Ö
      
      # --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ò–ó–í–õ–ï–ß–ï–ù–ò–ï ID –ß–ê–¢–ê –ò–ó notify.xxx ---
      notify_target_id: >-
        {% set entity_id = telegram_notifications_id | default('') %}
        {% set chat_id_part = entity_id | regex_replace(find='^.+_', replace='') | string | trim %}
        {% set final_id = chat_id_part %}
        {% if final_id | length > 10 and not final_id.startswith('-') %}
          {% set final_id = '-' ~ final_id %}
        {% endif %}
        {{ [final_id] }}
      
      # --- –§–†–ê–ó–´ –ò–ó INPUT (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞) ---
      phrase_left_home: !input message_left_home
      phrase_returned_home: !input message_returned_home
      phrase_button_where: !input button_text_where_now
      phrase_button_all: !input button_text_show_all
      phrase_request_all: !input message_request_all
      phrase_unknown: !input message_location_unknown
      phrase_home_status: !input message_home_status
      
      # –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ò –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –ò–ú–ï–ù–ò –û–¢–ü–†–ê–í–ò–¢–ï–õ–Ø (sender_name)
      sender_name: >-
        {% if trigger.platform == 'event' and trigger.event is defined %}
          {% set data = trigger.event.data | default({}) %}
          {% if trigger.id == 'command_request' %}
            {% set user_data = data.user_data | default({}) %}
            {% set first = data.from_first | default(user_data.first_name) | default('') %}
            {% set last = user_data.last_name | default('') %}
            {% set username = user_data.username | default('') %}
            {% set user_id = user_data.id | default('') %}
            
            {% if first | length > 0 %}
              {% if last | length > 0 %}
                {{ first }} {{ last }}
              {% else %}
                {{ first }}
              {% endif %}
            {% elif username | length > 0 %}
              @{{ username }}
            {% elif user_id | string | length > 0 %}
              [ID: {{ user_id }}]
            {% else %}
              –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            {% endif %}
          {% elif trigger.id == 'location_request' %}
            {% set first_name = data.from_first | default('') %}
            {% set user_id = data.user_id | default('') %}
            {% if first_name | length > 0 %}
              {{ first_name }}
            {% elif user_id | string | length > 0 %}
              [ID: {{ user_id }}]
            {% else %}
              –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            {% endif %}
          {% else %}
            ''
          {% endif %}
        {% else %}
          ''
        {% endif %}
      
  - choose:
      # –í–´–ë–û–† 1: –£—Ö–æ–¥ –∏–∑ –¥–æ–º–∞ üö∂ (State Trigger)
      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'not_home' }}"
        sequence:
          - variables:
              triggered_person_id: "{{ trigger.entity_id }}"
              triggered_person_name: "{{ state_attr(trigger.entity_id, 'friendly_name') | default(trigger.entity_id.split('.')[1]) }}"
              # –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID, –≤–∫–ª—é—á–∞—è –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
              button_command: "/–≥–¥–µ_{{ trigger.entity_id.split('.')[1] }}"
          
          - service: telegram_bot.send_message
            data:
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {name}
              message: "{{ phrase_left_home | replace('{name}', triggered_person_name) }}"
              target: "{{ notify_target_id }}"
              parse_mode: plain_text
              inline_keyboard:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                - "{{ phrase_button_where | replace('{name}', triggered_person_name) }}:{{ button_command }}"
                - "{{ phrase_button_all }}:{{ all_command }}"
          
      # –í–´–ë–û–† 2: –ü—Ä–∏—Ö–æ–¥ –¥–æ–º–æ–π üè° (State Trigger)
      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'home' }}"
        sequence:
          - variables:
              triggered_person_name: "{{ state_attr(trigger.entity_id, 'friendly_name') | default(trigger.entity_id.split('.')[1]) }}"
          
          - service: telegram_bot.send_message
            data:
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {name}
              message: "{{ phrase_returned_home | replace('{name}', triggered_person_name) }}"
              target: "{{ notify_target_id }}"
              parse_mode: plain_text
          
      # ----------------------------------------------------------------------
      # –í–´–ë–û–† 3: –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –û–î–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Callback) üìç
      # ----------------------------------------------------------------------
      - conditions:
          - condition: trigger
            id: location_request 
          - condition: template
            value_template: >
              {% set full_id = trigger.event.data.command | regex_replace(find='/–≥–¥–µ_', replace='') %}
              {{ trigger.event.data.command.startswith('/–≥–¥–µ_') and 'person.' + full_id in tracked_persons_ids }}
        sequence:
          - variables:
              # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º regex_replace –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–º–µ–Ω —Å '_'
              target_name_id: "{{ trigger.event.data.command | regex_replace(find='/–≥–¥–µ_', replace='') }}"
              target_person_id: "person.{{ target_name_id }}" 
              target_person_name: "{{ state_attr(target_person_id, 'friendly_name') | default(target_person_id.split('.')[1]) }}"
              chat_id_response: "{{ trigger.event.data.chat_id | int }}"
          
          - service: telegram_bot.answer_callback_query
            data:
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "–ó–∞–ø—Ä–æ—Å –æ—Ç {{ sender_name }}. –ò—â—É {{ target_person_name }}... ‚è≥"
              show_alert: false
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –∫–∞—Ä—Ç—ã
          - choose:
              # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ï–°–¢–¨
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(target_person_id, 'latitude') is not none }}"
                sequence:
                  - variables:
                      status_message: |-
                        {% set current_state = states(target_person_id) %}
                        {% set person_name = target_person_name %}
                        
                        {% if current_state == 'home' %}
                          {{ person_name }} {{ phrase_home_status }}
                        {% elif current_state != 'not_home' %}
                          –ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ {{ person_name }}: **{{ current_state }}** üìç
                        {% else %}
                          {{ person_name }} –Ω–µ –¥–æ–º–∞! üó∫Ô∏è
                        {% endif %}
                        –ó–∞–ø—Ä–æ—à–µ–Ω–æ: {{ sender_name }}
                    
                  - service: telegram_bot.send_message
                    data:
                      target: "{{ chat_id_response }}"
                      message: "{{ status_message }}"
                      parse_mode: markdown
                      
                  - service: telegram_bot.send_location
                    data:
                      target: "{{ chat_id_response }}"
                      latitude: "{{ state_attr(target_person_id, 'latitude') }}"
                      longitude: "{{ state_attr(target_person_id, 'longitude') }}"
                  
              # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ù–ï–¢
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(target_person_id, 'latitude') is none }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: "{{ chat_id_response }}"
                      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {name}
                      message: "{{ phrase_unknown | replace('{name}', target_person_name) }}"
                      parse_mode: plain_text

      # ----------------------------------------------------------------------
      # –í–´–ë–û–† 4: –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Callback - –∫–Ω–æ–ø–∫–∞) üåê
      # ----------------------------------------------------------------------
      - conditions:
          - condition: trigger
            id: location_request 
          - condition: template
            value_template: "{{ trigger.event.data.command == all_command }}"
        sequence:
          - variables:
              chat_id_response: "{{ trigger.event.data.chat_id | int }}"
          
          - service: telegram_bot.answer_callback_query
            data:
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "–ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç {{ sender_name }}. –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É... üó∫Ô∏è"
              show_alert: false
              
          - service: telegram_bot.send_message
            data:
              target: "{{ chat_id_response }}"
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {count} –∏ {sender}
              message: "{{ phrase_request_all | replace('{count}', (tracked_persons_ids | count)) | replace('{sender}', sender_name) }}"
              parse_mode: plain_text

          # –¶–∏–∫–ª –ø–æ –≤—Å–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
          - repeat:
              for_each: "{{ tracked_persons_ids }}"
              sequence:
                - variables:
                    target_person_id: "{{ repeat.item }}" 
                    target_person_name: "{{ state_attr(repeat.item, 'friendly_name') | default(repeat.item.split('.')[1]) }}"

                - choose:
                    # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ï–°–¢–¨
                    - conditions:
                        - condition: template
                          value_template: "{{ state_attr(target_person_id, 'latitude') is not none }}"
                      sequence:
                        - variables:
                            status_message: |-
                              {% set current_state = states(target_person_id) %}
                              {% set person_name = target_person_name %}
                              
                              {% if current_state == 'home' %}
                                {{ person_name }} {{ phrase_home_status }}
                              {% elif current_state != 'not_home' %}
                                –ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ {{ person_name }}: **{{ current_state }}** üìç
                              {% else %}
                                {{ person_name }} –Ω–µ –¥–æ–º–∞! üó∫Ô∏è
                              {% endif %}
                              
                        - service: telegram_bot.send_message
                          data:
                            target: "{{ chat_id_response }}"
                            message: "{{ status_message }}"
                            parse_mode: markdown 
                            
                        - service: telegram_bot.send_location
                          data:
                            target: "{{ chat_id_response }}"
                            latitude: "{{ state_attr(target_person_id, 'latitude') }}"
                            longitude: "{{ state_attr(target_person_id, 'longitude') }}"
                        
                    # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ù–ï–¢
                    - conditions:
                        - condition: template
                          value_template: "{{ state_attr(target_person_id, 'latitude') is none }}"
                      sequence:
                        - service: telegram_bot.send_message
                          data:
                            target: "{{ chat_id_response }}"
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {name}
                            message: "{{ phrase_unknown | replace('{name}', target_person_name) }}"
                            parse_mode: plain_text
          
      # ----------------------------------------------------------------------
      # –í–´–ë–û–† 5: –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Command - —Ç–µ–∫—Å—Ç) ‚å®Ô∏è
      # ----------------------------------------------------------------------
      - conditions:
          - condition: trigger
            id: command_request 
          - condition: template
            value_template: "{{ trigger.event.data.command | trim == all_command }}"
        sequence:
          - variables:
              chat_id_response: "{{ trigger.event.data.chat_id | int }}"
          
          - service: telegram_bot.send_message
            data:
              target: "{{ chat_id_response }}"
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {count} –∏ {sender}
              message: "{{ phrase_request_all | replace('{count}', (tracked_persons_ids | count)) | replace('{sender}', sender_name) }}"
              parse_mode: plain_text

          # –¶–∏–∫–ª –ø–æ –≤—Å–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –í–´–ë–û–† 4)
          - repeat:
              for_each: "{{ tracked_persons_ids }}"
              sequence:
                - variables:
                    target_person_id: "{{ repeat.item }}" 
                    target_person_name: "{{ state_attr(repeat.item, 'friendly_name') | default(repeat.item.split('.')[1]) }}"

                - choose:
                    # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ï–°–¢–¨
                    - conditions:
                        - condition: template
                          value_template: "{{ state_attr(target_person_id, 'latitude') is not none }}"
                      sequence:
                        - variables:
                            status_message: |-
                              {% set current_state = states(target_person_id) %}
                              {% set person_name = target_person_name %}
                              
                              {% if current_state == 'home' %}
                                {{ person_name }} {{ phrase_home_status }}
                              {% elif current_state != 'not_home' %}
                                –ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ {{ person_name }}: **{{ current_state }}** üìç
                              {% else %}
                                {{ person_name }} –Ω–µ –¥–æ–º–∞! üó∫Ô∏è
                              {% endif %}
                              
                        - service: telegram_bot.send_message
                          data:
                            target: "{{ chat_id_response }}"
                            message: "{{ status_message }}"
                            parse_mode: markdown 
                            
                        - service: telegram_bot.send_location
                          data:
                            target: "{{ chat_id_response }}"
                            latitude: "{{ state_attr(target_person_id, 'latitude') }}"
                            longitude: "{{ state_attr(target_person_id, 'longitude') }}"
                        
                    # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ù–ï–¢
                    - conditions:
                        - condition: template
                          value_template: "{{ state_attr(target_person_id, 'latitude') is none }}"
                      sequence:
                        - service: telegram_bot.send_message
                          data:
                            target: "{{ chat_id_response }}"
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞–º–µ–Ω—è—è {name}
                            message: "{{ phrase_unknown | replace('{name}', target_person_name) }}"
                            parse_mode: plain_text
                        
mode: parallel
max: 10
