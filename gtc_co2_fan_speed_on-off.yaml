blueprint:
  name: üí® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–µ–π –ø–æ CO2 v13.1 (–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
  description: >-
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º –ø–æ CO2,
    –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–º–æ—â–Ω–∏–∫ `input_select` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –∏
    –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞. –õ–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è **–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**
    –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ RUNNING (IDLE/—Å–≤–æ–±–æ–¥–Ω–æ).
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/gtc_co2_fan_speed_on-off.yaml
  
  input:
    co2_sensors:
      name: –î–∞—Ç—á–∏–∫–∏ CO2
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ CO2.
      selector:
        entity:
          domain: sensor
          device_class: carbon_dioxide
          multiple: true
    target_fan:
      name: –¶–µ–ª–µ–≤–æ–π –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä
      description: >-
        –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è.
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å —Å –¥–æ–º–µ–Ω–Ω–æ–º `fan` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `fan.gtc_fan`),**
        –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (`set_percentage`).
      default: fan.gtc_fan
      selector:
        entity:
          domain: fan
    automation_mode_select:
      name: –ü–æ–º–æ—â–Ω–∏–∫ –†–µ–∂–∏–º–∞ (Input Select)
      description: >-
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π** –ø–æ–º–æ—â–Ω–∏–∫ —Ç–∏–ø–∞ `input_select`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è
        –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:
        * **RUNNING:** (IDLE/–°–≤–æ–±–æ–¥–Ω–æ) –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –≤–∫–ª—é—á–µ–Ω–∏—é.
        * **WAITING:** (ACTIVE/–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞) –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –±—ã–ª–∞
          –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º CO2.
        *–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:* –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å –¥–≤—É–º—è –æ–ø—Ü–∏—è–º–∏: **`RUNNING`** –∏ **`WAITING`**.
      selector:
        entity:
          domain: input_select
    previous_co2_helper:
      name: –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ CO2
      description: >-
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π** –ø–æ–º–æ—â–Ω–∏–∫ —Ç–∏–ø–∞ `input_number`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è
        —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è CO2 –¥–ª—è –ª–æ–≥–∏–∫–∏ –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–∞.
      selector:
        entity:
          domain: input_number
    low_co2_max:
      name: –ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ CO2 (–º–∞–∫—Å, ppm)
      description: >-
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ CO2, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –ª–∏–±–æ
        **–≤—ã–∫–ª—é—á–∏—Ç—å—Å—è**, –ª–∏–±–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ **–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏**.
      default: 600
      selector:
        number:
          min: 400
          max: 1000
          step: 1
          mode: box
          unit_of_measurement: "ppm"
    max_speed:
      name: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞ (%)
      description: >-
        –°–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–µ—Ç —Ä–∞–∑–æ–≥–Ω–∞—Ç—å—Å—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä
        –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ CO2.
      default: 40
      selector:
        number:
          min: 10
          max: 100
          step: 10
          mode: slider
          unit_of_measurement: "%"
    co2_increase_threshold:
      name: –ü–æ—Ä–æ–≥ –ø–æ–≤—ã—à–µ–Ω–∏—è CO2 –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è (ppm)
      description: >-
        –ù–∞—Å–∫–æ–ª—å–∫–æ CO2 –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å '–ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ CO2 (–º–∞–∫—Å, ppm)', —á—Ç–æ–±—ã
        –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –≤–∫–ª—é—á–∏–ª—Å—è (–ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + —ç—Ç–æ—Ç –ø–æ—Ä–æ–≥).
      default: 15
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
          unit_of_measurement: "ppm"
    co2_change_threshold:
      name: –ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è CO2 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (ppm)
      description: >-
        –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ CO2, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–ª—è **–°–ù–ò–ñ–ï–ù–ò–Ø** —Å–∫–æ—Ä–æ—Å—Ç–∏.
      default: 15
      selector:
        number:
          min: 0
          max: 50
          step: 1
          mode: box
          unit_of_measurement: "ppm"
    start_speed:
      name: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–°—Ç–∞—Ä—Ç–æ–≤–∞—è –°–∫–æ—Ä–æ—Å—Ç—å (%)
      description: >-
        –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ 0%, –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –±—É–¥–µ—Ç –í–´–ö–õ–Æ–ß–ê–¢–¨–°–Ø –ø—Ä–∏ –Ω–∏–∑–∫–æ–º CO2,
        –Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞ —Å 10%. –ï—Å–ª–∏ >0%, –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è
        –í–ö–õ–Æ–ß–ï–ù–ù–´–ú –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏.
      default: 0
      selector:
        number:
          min: 0
          max: 100
          step: 10
          mode: slider
          unit_of_measurement: "%"
    update_frequency:
      name: –ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (minutes)
      description: –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ CO2 –≤ —Ñ–æ—Ä–º–∞—Ç–µ time_pattern (–Ω–∞–ø—Ä–∏–º–µ—Ä, "/5" –¥–ª—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç).
      default: "/5"
      selector:
        text:
mode: single
trigger:
  - platform: time_pattern
    minutes: !input update_frequency
action:
  - variables:
      co2_sensors_list: !input co2_sensors
      target_fan_entity: !input target_fan
      low_co2_max_val: !input low_co2_max
      max_speed_val: !input max_speed
      co2_increase_threshold_val: !input co2_increase_threshold
      co2_change_threshold_val: !input co2_change_threshold
      start_speed_val: !input start_speed
      previous_co2_helper_entity_id: !input previous_co2_helper
      mode_select_entity_id: !input automation_mode_select
      
      current_mode: "{{ states(mode_select_entity_id) }}"
      is_fan_on: "{{ is_state(target_fan_entity, 'on') }}"

      # –†–∞—Å—á–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏ start_speed > 0)
      min_fan_speed: >
        {% if start_speed_val | float == 0 %}
          10
        {% else %}
          {{ start_speed_val }}
        {% endif %}

      avg_co2: >
        {% set valid_readings = co2_sensors_list
          | map('states')
          | map('float', 0)
          | select('>', 0)
          | list
        %}
        {% if valid_readings | length > 0 %}
          {{ (valid_readings | sum / valid_readings | length) | round(1) }}
        {% else %}
          0
        {% endif %}
        
      current_speed: >
        {{ state_attr(target_fan_entity, 'percentage') | float(0) }}
      previous_co2: "{{ states(previous_co2_helper_entity_id) | float(0) }}"

  - choose:
      # --- –õ–û–ì–ò–ö–ê 1: –í–ö–õ–Æ–ß–ï–ù–ò–ï –í–ï–ù–¢–ò–õ–Ø–¢–û–†–ê (–° –ë–õ–û–ö–ò–†–û–í–ö–û–ô) ---
      - conditions:
          - condition: template
            value_template: "{{ not is_fan_on }}"
          - condition: template
            value_template: >
              {{ avg_co2 >= (low_co2_max_val | float + co2_increase_threshold_val | float) }}
          - condition: template
            value_template: "{{ current_mode == 'RUNNING' }}"
        sequence:
          - service: fan.turn_on
            target:
              entity_id: "{{ target_fan_entity }}"
          - delay:
              seconds: 50
          - service: fan.set_percentage
            target:
              entity_id: "{{ target_fan_entity }}"
            data:
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º min_fan_speed –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
              percentage: "{{ min_fan_speed }}"
          - service: input_select.select_option
            target:
              entity_id: "{{ mode_select_entity_id }}"
            data:
              option: WAITING
#          - service: persistent_notification.create
#            data:
#              title: "CO2 –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è: –í–ö–õ–Æ–ß–ï–ù–ê"
#              message: "CO2 ({{ avg_co2 }} ppm) –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞. –†–µ–∂–∏–º –ê–∫—Ç–∏–≤–µ–Ω (WAITING)."
              
      # --- –õ–û–ì–ò–ö–ê 2: –í–ï–ù–¢–ò–õ–Ø–¢–û–† –í–ö–õ–Æ–ß–ï–ù (–†–ï–ì–£–õ–ò–†–û–í–ö–ê –°–ö–û–†–û–°–¢–ò –ò –í–´–ö–õ–Æ–ß–ï–ù–ò–ï) ---
      - conditions:
          - condition: template
            value_template: "{{ is_fan_on }}"
        sequence:
          - choose:
              # –í–ê–†–ò–ê–ù–¢ 2.1: –í–´–ö–õ–Æ–ß–ï–ù–ò–ï –ò–õ–ò –£–°–¢–ê–ù–û–í–ö–ê –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ô –°–ö–û–†–û–°–¢–ò (CO2 –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞)
              - conditions:
                  - condition: template
                    value_template: |
                      {{ avg_co2 < low_co2_max_val | float }}
                sequence:
#                  - service: persistent_notification.create
#                    data:
#                      title: "CO2 –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è: –ù–ò–ó–ö–ò–ô CO2"
#                      message: "CO2 ({{ avg_co2 }} ppm) –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞. –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º –û–∂–∏–¥–∞–Ω–∏—è (IDLE)."
                  
                  # --- –õ–û–ì–ò–ö–ê –í–´–ö–õ–Æ–ß–ï–ù–ò–Ø/–ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ô –°–ö–û–†–û–°–¢–ò ---
                  - if:
                      # –ï—Å–ª–∏ start_speed_val == 0 (–ø–æ–ª–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ)
                      - condition: template
                        value_template: "{{ start_speed_val | float == 0 }}"
                    then:
                      # –®—Ç–∞—Ç–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–≤–∏–º 10%, –ø–æ—Ç–æ–º –≤—ã–∫–ª—é—á–∞–µ–º.
                      - service: fan.set_percentage
                        target:
                          entity_id: "{{ target_fan_entity }}"
                        data:
                          percentage: 10
                      - delay:
                          seconds: 5
                      - service: fan.turn_off
                        target:
                          entity_id: "{{ target_fan_entity }}"
                      - service: input_select.select_option
                        target:
                          entity_id: "{{ mode_select_entity_id }}"
                        data:
                          option: RUNNING
                    else:
                      # –ï—Å–ª–∏ start_speed_val > 0, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –Ω–µ –≤—ã–∫–ª—é—á–∞–µ–º.
                      - service: fan.set_percentage
                        target:
                          entity_id: "{{ target_fan_entity }}"
                        data:
                          percentage: "{{ start_speed_val }}"
                  # --- –ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò ---
              
              # –í–ê–†–ò–ê–ù–¢ 2.2: –°–ù–ò–ñ–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò (–†–µ–∂–∏–º WAITING —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
              - conditions:
                  - condition: template
                    value_template: >
                      {{ (previous_co2 - avg_co2) >= co2_change_threshold_val | float }}
                sequence:
                  - variables:
                      # –ò—Å–ø–æ–ª—å–∑—É–µ–º min_fan_speed, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–ª–æ–∫–µ variables
                      new_speed: >
                        {{ [current_speed - 10, min_fan_speed] | max }}
                  - service: fan.set_percentage
                    target:
                      entity_id: "{{ target_fan_entity }}"
                    data:
                      percentage: "{{ new_speed }}"
#                  - service: persistent_notification.create
#                    data:
#                        title: "CO2 –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è: –°–ù–ò–ñ–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò"
#                        message: "CO2 —Å–Ω–∏–∂–∞–µ—Ç—Å—è. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ {{ new_speed | int }}%."
                      
              # –í–ê–†–ò–ê–ù–¢ 2.3: –ü–û–í–´–®–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò (–†–µ–∂–∏–º WAITING —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
              - conditions:
                  - condition: template
                    value_template: |
                      {{ avg_co2 > previous_co2 }}
                sequence:
                  - variables:
                      new_speed: >
                        {{ [current_speed + 10, max_speed_val] | min }}
                  - service: fan.set_percentage
                    target:
                      entity_id: "{{ target_fan_entity }}"
                    data:
                      percentage: "{{ new_speed }}"
#                  - service: persistent_notification.create
#                    data:
#                        title: "CO2 –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è: –ü–û–í–´–®–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò"
#                        message: "CO2 —Ä–∞—Å—Ç–µ—Ç. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ {{ new_speed | int }}%."

  # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ CO2 –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, –æ–¥–∏–Ω —Ä–∞–∑.
  - service: input_number.set_value
    data:
      entity_id: "{{ previous_co2_helper_entity_id }}"
      value: "{{ avg_co2 }}"