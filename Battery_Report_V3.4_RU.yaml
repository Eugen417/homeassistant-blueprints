id: automation_otchet_po_sostoianiiu_batarei_v3_8_ru

blueprint:
  name: ü™´ –û—Ç—á–µ—Ç –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –±–∞—Ç–∞—Ä–µ–π (v3.8)
  description: |
    –°–æ–∑–¥–∞–µ—Ç –¥–≤–∞ –∫—Ä–∞—Ç–∫–∏—Ö –æ—Ç—á–µ—Ç–∞ (—Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ "–ó–∞–º–µ–Ω–∞" –∏ "–ó–∞—Ä—è–¥–∫–∞") –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º, –∑–∞—Ä—è–¥ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∏–∂–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è. 
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏/–∏–ª–∏ –≤ Telegram –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è.
    
    **v3.10:** –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±–µ–∑ —Å–≤—è–∑–∏".
    **HTML:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è Telegram.
    **OFFLINE:** –í –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–≤—è–∑—å.
    
    **–í–∞–∂–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ!** –î–ª—è —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é **HA-Battery Notes**.
  domain: automation

  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/Battery_Report_V3.4_RU.yaml

  input:
    # 1. –¢–†–ò–ì–ì–ï–†–´
    trigger_time:
      name: ‚è∞ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞
      description: –í—Ä–µ–º—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 08:00:00).
      selector:
        time:
    trigger_days:
      name: üóìÔ∏è –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ö–†–ê–¢–ö–ò–ô –û–¢–ß–ï–¢)
      description: –í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏, –∫–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ö–†–ê–¢–ö–ò–ô –æ—Ç—á–µ—Ç. –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
              value: Mon
            - label: –í—Ç–æ—Ä–Ω–∏–∫
              value: Tue
            - label: –°—Ä–µ–¥–∞
              value: Wed
            - label: –ß–µ—Ç–≤–µ—Ä–≥
              value: Thu
            - label: –ü—è—Ç–Ω–∏—Ü–∞
              value: Fri
            - label: –°—É–±–±–æ—Ç–∞
              value: Sat
            - label: –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
              value: Sun

    # 2. –£–°–¢–†–û–ô–°–¢–í–ê –ò –ü–û–†–û–ì–ò
    mobile_notify_target:
      name: üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Home Assistant)
      description: –í—ã–±–µ—Ä–∏—Ç–µ –û–î–ù–û —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
      default: ""
      selector:
        device:
          integration: mobile_app
    
    telegram_notify_target:
      name: üí¨ –¶–µ–ª–µ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ Telegram (notify.telegram_bot_...).
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

    send_full_report_option:
      name: üìä –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –≤—Ç–æ—Ä—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (Telegram)?
      description: –í–∫–ª—é—á–∏—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –±–∞—Ç–∞—Ä–µ–π.
      default: false
      selector:
        boolean:

    full_report_days:
      name: üìÖ –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ü–û–õ–ù–û–ì–û –û–¢–ß–ï–¢–ê (Telegram)
      description: –í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞. –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (–ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ–ø—Ü–∏–∏).
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
              value: Mon
            - label: –í—Ç–æ—Ä–Ω–∏–∫
              value: Tue
            - label: –°—Ä–µ–¥–∞
              value: Wed
            - label: –ß–µ—Ç–≤–µ—Ä–≥
              value: Thu
            - label: –ü—è—Ç–Ω–∏—Ü–∞
              value: Fri
            - label: –°—É–±–±–æ—Ç–∞
              value: Sat
            - label: –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
              value: Sun
    
    critical_level:
      name: ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å (%)
      description: –£—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞, –Ω–∏–∂–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ —Ç—Ä–µ–±—É—é—â–µ–µ –≤–Ω–∏–º–∞–Ω–∏—è.
      default: 15
      selector:
        number:
          min: 1
          max: 99
          step: 1
          unit_of_measurement: "%"
          mode: box
          
    excluded_sensors:
      name: üóëÔ∏è –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Å–µ–Ω—Å–æ—Ä—ã
      description: –°–µ–Ω—Å–æ—Ä—ã —É—Ä–æ–≤–Ω—è –∑–∞—Ä—è–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –æ—Ç—á–µ—Ç–∞.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: sensor
              device_class: battery

    # 3. –ù–ê–°–¢–†–û–ô–ö–ê –¢–ï–ö–°–¢–ê –ò –§–†–ê–ó
    text_disposable_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç - –ó–ê–ú–ï–ù–ê)
      default: "‚ö†Ô∏è <b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –∑–∞–º–µ–Ω—ã –±–∞—Ç–∞—Ä–µ–∏:</b>\n"
      selector:
        text:
    text_disposable_action:
      name: üìù –®–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏ (–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç - –ó–ê–ú–ï–ù–ê)
      default: "<b>%LEVEL%%</b> ‚ôªÔ∏è –ó–ê–ú–ï–ù–ê! (–¢–∏–ø: %TYPE%, –ö–æ–ª-–≤–æ: %QTY%)"
      selector:
        text:
    text_disposable_ok:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ (–ó–ê–ú–ï–ù–ê –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      default: "–í—Å–µ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã–µ –±–∞—Ç–∞—Ä–µ–∏ –∏–º–µ—é—Ç –∑–∞—Ä—è–¥ –≤—ã—à–µ "
      selector:
        text:
    text_rechargeable_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç - –ó–ê–†–Ø–î–ö–ê)
      default: "‚ö†Ô∏è <b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–¥–∑–∞—Ä—è–¥–∫–∏:</b>\n"
      selector:
        text:
    text_rechargeable_action:
      name: üìù –®–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏ (–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç - –ó–ê–†–Ø–î–ö–ê)
      default: "<b>%LEVEL%%</b> üîå –ó–ê–†–Ø–î–ö–ê!"
      selector:
        text:
    text_rechargeable_ok:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ (–ó–ê–†–Ø–î–ö–ê –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      default: "–í—Å–µ –∑–∞—Ä—è–∂–∞–µ–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–º–µ—é—Ç –∑–∞—Ä—è–¥ –≤—ã—à–µ "
      selector:
        text:
    text_full_replace_label:
      name: üìù –ú–µ—Ç–∫–∞ –∑–∞–º–µ–Ω—ã (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: " ‚ôªÔ∏è <b>–ó–ê–ú–ï–ù–ê!</b>"
      selector:
        text:
    text_full_charge_label:
      name: üìù –ú–µ—Ç–∫–∞ –∑–∞—Ä—è–¥–∫–∏ (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: " üîå <b>–ó–ê–†–Ø–î–ö–ê!</b>"
      selector:
        text:
    text_rechargeable_type:
      name: üìù –ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ê–ö–ë
      default: "–í—Å—Ç—Ä–æ–µ–Ω—ã–π –ê–ö–ë"
      selector:
        text:
    text_unknown_type:
      name: üìù –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
      default: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¢–∏–ø"
      selector:
        text:
    text_summary_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–æ–¥–∫–∏
      default: "--- \n\nüîã <b>–°–≤–æ–¥–∫–∞ –ø–æ –¢–∏–ø—É –ë–∞—Ç–∞—Ä–µ–∏:</b>\n"
      selector:
        text:
    text_grand_total:
      name: üìù –®–∞–±–ª–æ–Ω –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      description: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTML —Ç–µ–≥–∏ (b, i).
      default: "<i>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤:</i> <b>%TOTAL%</b> —à—Ç."
      selector:
        text:
    text_offline_header:
      name: üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
      description: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º unavailable/unknown.
      default: "‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±–µ–∑ —Å–≤—è–∑–∏ (Unavailable/Unknown):</b>"
      selector:
        text:
    text_no_sensors:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ–Ω—Å–æ—Ä–æ–≤
      default: "–°–µ–Ω—Å–æ—Ä—ã –±–∞—Ç–∞—Ä–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
      selector:
        text:
    text_no_summary_data:
      name: üìù –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–≤–æ–¥–∫–∏
      default: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–ø–∞—Ö –±–∞—Ç–∞—Ä–µ–π –¥–ª—è –æ—Ç—á–µ—Ç–∞."
      selector:
        text:
    title_short_replace_low:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π, –ó–∞–º–µ–Ω–∞, –ù–∏–∑–∫–∏–π)
      default: "üîã –û—Ç—á—ë—Ç –ë–∞—Ç–∞—Ä–µ—è+: ü™´‚ôªÔ∏è –ó–∞—Ä—è–¥ < "
      selector:
        text:
    title_short_replace_ok:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π, –ó–∞–º–µ–Ω–∞, OK)
      default: "üîã –û—Ç—á—ë—Ç –ë–∞—Ç–∞—Ä–µ—è+: –ó–∞–º–µ–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
      selector:
        text:
    title_short_charge_low:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π, –ó–∞—Ä—è–¥–∫–∞, –ù–∏–∑–∫–∏–π)
      default: "üîã –û—Ç—á—ë—Ç –ë–∞—Ç–∞—Ä–µ—è+: ü™´üîå –ó–∞—Ä—è–¥ < "
      selector:
        text:
    title_short_charge_ok:
      name: üì± –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ö—Ä–∞—Ç–∫–∏–π, –ó–∞—Ä—è–¥–∫–∞, OK)
      default: "üîã–û—Ç—á—ë—Ç –ë–∞—Ç–∞—Ä–µ—è+: –ó–∞—Ä—è–¥–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
      selector:
        text:
    title_full_report:
      name: üìä –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç)
      default: "üîã <b>–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ë–∞—Ç–∞—Ä–µ—è+ (–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ —É—Ä–æ–≤–Ω—é):</b>"
      selector:
        text:

variables:
  mobile_device_id: !input mobile_notify_target
  telegram_notify_entities: !input telegram_notify_target 
  critical_threshold: !input critical_level
  excluded_entity_ids: !input excluded_sensors
  send_full_report: !input send_full_report_option
  full_report_days: !input full_report_days 
  trigger_days: !input trigger_days
  # Text variables
  text_disposable_header: !input text_disposable_header
  text_disposable_action: !input text_disposable_action
  text_disposable_ok: !input text_disposable_ok
  text_rechargeable_header: !input text_rechargeable_header
  text_rechargeable_action: !input text_rechargeable_action
  text_rechargeable_ok: !input text_rechargeable_ok
  text_full_replace_label: !input text_full_replace_label
  text_full_charge_label: !input text_full_charge_label
  text_rechargeable_type: !input text_rechargeable_type
  text_unknown_type: !input text_unknown_type
  text_summary_header: !input text_summary_header
  text_grand_total: !input text_grand_total
  text_offline_header: !input text_offline_header
  text_no_sensors: !input text_no_sensors
  text_no_summary_data: !input text_no_summary_data
  title_short_replace_low: !input title_short_replace_low
  title_short_replace_ok: !input title_short_replace_ok
  title_short_charge_low: !input title_short_charge_low
  title_short_charge_ok: !input title_short_charge_ok
  title_full_report: !input title_full_report

trigger:
  - platform: time
    at: !input trigger_time

action:
  # ----------------------------------------------------------------------
  # 1. –†–ê–°–°–ß–ï–¢ –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô (–ö–†–ê–¢–ö–ò–ô –ò –ü–û–õ–ù–´–ô)
  # ----------------------------------------------------------------------
  - alias: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ—Ç—á–µ—Ç—ã
    variables:
      threshold: "{{ critical_threshold | int }}"
      exclude_list: "{{ excluded_entity_ids.entity_id | default([]) }}"
      
      # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã—Ö –±–∞—Ç–∞—Ä–µ—è—Ö (–ó–∞–º–µ–Ω–∞) - –ö–†–ê–¢–ö–ò–ô –û–¢–ß–ï–¢ 1
      disposable_message: >-
        {% set ns = namespace(disposable_lines=[]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            {% if numerical_level >= 0 and numerical_level < threshold %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %} 
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              {% if not is_rechargeable %}
                {% set battery_quantity = sensor.attributes.battery_quantity | default('1') %}
                {% set line_action = text_disposable_action | replace('%LEVEL%', numerical_level | string) | replace('%TYPE%', battery_type | string) | replace('%QTY%', battery_quantity | string) %}
                {% set line = cleaned_name ~ ": " ~ line_action %}
                {% set ns.disposable_lines = ns.disposable_lines + [{ 'level': numerical_level, 'line': line }] %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_disposable = ns.disposable_lines | sort(attribute='level') %}
        {% set disposable_output = sorted_disposable | map(attribute='line') | list %}
        {% if disposable_output | length > 0 %}
          {{ text_disposable_header ~ disposable_output | join('\n') }}
        {% else %}
          {{ text_disposable_ok ~ critical_threshold ~ "%." }}
        {% endif %}

      # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞—Ä—è–∂–∞–µ–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–ó–∞—Ä—è–¥–∫–∞) - –ö–†–ê–¢–ö–ò–ô –û–¢–ß–ï–¢ 2
      rechargeable_message: >-
        {% set ns = namespace(rechargeable_lines=[]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            {% if numerical_level >= 0 and numerical_level < threshold %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %}
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              {% if is_rechargeable %}
                {% set line_action = text_rechargeable_action | replace('%LEVEL%', numerical_level | string) %}
                {% set line = cleaned_name ~ ": " ~ line_action %}
                {% set ns.rechargeable_lines = ns.rechargeable_lines + [{ 'level': numerical_level, 'line': line }] %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_rechargeable = ns.rechargeable_lines | sort(attribute='level') %}
        {% set rechargeable_output = sorted_rechargeable | map(attribute='line') | list %}
        {% if rechargeable_output | length > 0 %}
          {{ text_rechargeable_header ~ rechargeable_output | join('\n') }}
        {% else %}
          {{ text_rechargeable_ok ~ critical_threshold ~ "%." }}
        {% endif %}
      
      # –û–¢–ß–ï–¢ 3: –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö (–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è)
      full_report_body_list: >-
        {% set ns = namespace(all_lines=[]) %}
        {% set yellow_boundary = 40 %}
        {% set red_boundary = 15 %}
        
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
            {% set numerical_level = sensor.attributes.battery_last_reported_level | float(default=-1) | int(default=-1) %}
            
            {% if numerical_level >= 0 %}
              {% set battery_type = sensor.attributes.battery_type | default('Unknown') %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %} 
              {% set is_rechargeable = (battery_type == 'Rechargeable' or 'F946B' in cleaned_name or 'F966B' in cleaned_name or 'privod' in cleaned_name) %}
              
              {% set status_icon = 'üü¢' %} 
              {% if numerical_level < red_boundary %}
                {% set status_icon = 'üî¥' %} 
              {% elif numerical_level < yellow_boundary %}
                {% set status_icon = 'üü°' %} 
              {% endif %}
              
              {% set status_label = '' %}
              {% if numerical_level < threshold %}
                {% set status_label = text_full_replace_label if not is_rechargeable else text_full_charge_label %}
              {% endif %}
              
              {% set details = "" %}
              {% if not is_rechargeable %}
                {% set battery_quantity = sensor.attributes.battery_quantity | default('1') %}
                {% set details = " (–¢–∏–ø: " ~ battery_type ~ ", –ö–æ–ª-–≤–æ: " ~ battery_quantity ~ " —à—Ç)" %}
              {% endif %}

              {% set line = status_icon ~ " " ~ cleaned_name ~ ": " ~ numerical_level ~ "%" ~ status_label ~ details %}
              {% set ns.all_lines = ns.all_lines + [{ 'level': numerical_level, 'line': line }] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted_all = ns.all_lines | sort(attribute='level', reverse=true) %}
        {% set all_output = sorted_all | map(attribute='line') | list %}
        
        {% if all_output | length > 0 %}
          {{ all_output | join('\n') }}
        {% else %}
          {{ text_no_sensors }}
        {% endif %}
        
      # –û–¢–ß–ï–¢ 4: –°–í–û–î–ö–ê –ü–û –¢–ò–ü–£ –ë–ê–¢–ê–†–ï–ò
      battery_types_summary: >-
        {% set ns = namespace(output_lines=[]) %}
        {% set all_battery_sensors = states.sensor 
            | selectattr('attributes.battery_last_reported_level', 'defined') 
            | rejectattr('entity_id', 'in', exclude_list) 
            | list %}
            
        {% set grouped_by_type = all_battery_sensors 
            | groupby('attributes.battery_type') %}
            
        {% for type, sensors in grouped_by_type %}
          {% set total_quantity = namespace(value=0) %}
          {% for sensor in sensors %}
            {% set quantity = sensor.attributes.battery_quantity | default('1') | int(default=1) %}
            {% set total_quantity.value = total_quantity.value + quantity %}
          {% endfor %}

          {% set display_type = type | default(text_unknown_type) | string %}
          {% if display_type == 'Rechargeable' %}
            {% set display_type = text_rechargeable_type %}
          {% endif %}

          {% set line = "‚Ä¢ " ~ display_type ~ " (–í—Å–µ–≥–æ: " ~ total_quantity.value ~ " —à—Ç)" %}
          {% set ns.output_lines = ns.output_lines + [line] %}
        {% endfor %}
        
        {% if ns.output_lines | length > 0 %}
          {{ text_summary_header ~ ns.output_lines | sort | join('\n') }}
        {% else %}
          {{ text_no_summary_data }}
        {% endif %}
      
      # –û–¢–ß–ï–¢ 5: –£–°–¢–†–û–ô–°–¢–í–ê –í–ù–ï –°–ï–¢–ò (UNAVAILABLE / UNKNOWN)
      offline_sensors_report: >-
        {% set ns = namespace(offline_lines=[]) %}
        {% for sensor in states.sensor %}
          {# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ battery_last_reported_level (–∑–Ω–∞—á–∏—Ç —ç—Ç–æ –±–∞—Ç–∞—Ä–µ–π–∫–∞) #}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list %}
            {# –ù–æ —Å–∞–º —Å—Ç–∞—Ç—É—Å —Å–µ–Ω—Å–æ—Ä–∞ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω #}
            {% if sensor.state in ['unavailable', 'unknown'] %}
              {% set name = sensor.attributes.friendly_name | default(sensor.entity_id) %}
              {% set cleaned_name = name | replace(' –ë–∞—Ç–∞—Ä–µ—è+', '') | trim %}
              {% set line = "‚ùì " ~ cleaned_name ~ " (–°—Ç–∞—Ç—É—Å: " ~ sensor.state ~ ")" %}
              {% set ns.offline_lines = ns.offline_lines + [line] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% if ns.offline_lines | length > 0 %}
          {{ text_offline_header ~ '\n' ~ ns.offline_lines | join('\n') }}
        {% endif %}

      # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ–±—â–µ–≥–æ –∫–æ–ª-–≤–∞
      grand_total_quantity: >-
        {% set total = namespace(value=0) %}
        {% set exclude_list_local = excluded_entity_ids.entity_id | default([]) %}
        {% for sensor in states.sensor %}
          {% if sensor.attributes.battery_last_reported_level is defined and sensor.entity_id not in exclude_list_local %}
            {% set quantity = sensor.attributes.battery_quantity | default('1') | int(default=1) %}
            {% set total.value = total.value + quantity %}
          {% endif %}
        {% endfor %}
        {{ total.value }}
        
      # –°–ë–û–†–ö–ê –ü–û–õ–ù–û–ì–û –û–¢–ß–ï–¢–ê (HTML) - –ü–û–†–Ø–î–û–ö: –ó–∞–≥–æ–ª–æ–≤–æ–∫ -> –ö–æ–ª-–≤–æ -> –°–ø–∏—Å–æ–∫ -> –¢–∏–ø—ã -> (–æ—Ç—Å—Ç—É–ø) -> –û—Ñ–ª–∞–π–Ω
      full_report_message: >
        {% set total_text = text_grand_total | replace('%TOTAL%', grand_total_quantity | default(0) | string) %}
        {% set header = title_full_report %}
        {# –î–æ–±–∞–≤–ª–µ–Ω–æ \n\n –ø–µ—Ä–µ–¥ offline_sensors_report –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ #}
        {{ header ~ '\n' ~ total_text ~ '\n\n' ~ full_report_body_list ~ '\n\n' ~ battery_types_summary ~ '\n\n' ~ offline_sensors_report }}


  # ----------------------------------------------------------------------
  # 2. –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê 1: –ù–ï–ó–ê–†–Ø–ñ–ê–ï–ú–´–ï (–ó–ê–ú–ï–ù–ê)
  # ----------------------------------------------------------------------
  - alias: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç 1 - –ù–µ–∑–∞—Ä—è–∂–∞–µ–º—ã–µ (–£—Å–ª–æ–≤–Ω–æ)
    choose:
      - conditions:
          - condition: template
            value_template: >
              {% set selected_days = trigger_days %}
              {% if selected_days | length > 0 %}
                {{ now().strftime('%a') in selected_days }}
              {% else %}
                {{ true }}
              {% endif %}
        sequence:
          # 2.1 –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          - alias: –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –û—Ç—á–µ—Ç –æ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã—Ö
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mobile_device_id is not none and mobile_device_id != '' }}"
                sequence:
                  - service: notify.mobile_app_{{ device_attr(mobile_device_id, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                    data:
                      title: >
                        {% if disposable_message.startswith('‚ö†Ô∏è') %}
                          {{ title_short_replace_low ~ critical_threshold ~ "%" }}
                        {% else %}
                          {{ title_short_replace_ok }}
                        {% endif %}
                      message: "{{ disposable_message | striptags }}" 
          
          # 2.2 Telegram Bot (HTML)
          - alias: Telegram - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—ã–µ ID —á–∞—Ç–æ–≤ –¥–ª—è –û—Ç—á–µ—Ç–∞ 1
            variables:
              target_chat_ids: >-
                {% set selected_entities_raw = telegram_notify_entities.entity_id | default([]) %}
                {% set selected_entities = [selected_entities_raw] | flatten %}
                {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
                {% set ns = namespace(target_ids=[]) %}
                {% for id_string in chat_id_strings %}
                  {% set cleaned_id = id_string | string | trim %}
                  {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
                    {% set id_with_hyphen = '-' ~ cleaned_id %}
                    {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
                  {% else %}
                    {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
                  {% endif %}
                {% endfor %}
                {{ ns.target_ids }}

          - alias: Telegram - –û—Ç—á–µ—Ç –æ –Ω–µ–∑–∞—Ä—è–∂–∞–µ–º—ã—Ö (HTML)
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ target_chat_ids | length > 0 }}" 
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: "{{ target_chat_ids }}" 
                      message: |
                        {% set report_body = disposable_message %}
                        {% if report_body.startswith('‚ö†Ô∏è') %}
                          {% set header = '<b>' ~ title_short_replace_low ~ critical_threshold ~ '%</b>' %}
                        {% else %}
                          {% set header = '<b>' ~ title_short_replace_ok ~ '</b>' %}
                        {% endif %}
                        {{ header ~ "\n\n" ~ report_body }}
                      parse_mode: html
  
  # ----------------------------------------------------------------------
  # 3. –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê 2: –ó–ê–†–Ø–ñ–ê–ï–ú–´–ï (–ó–ê–†–Ø–î–ö–ê)
  # ----------------------------------------------------------------------
  - alias: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç 2 - –ó–∞—Ä—è–∂–∞–µ–º—ã–µ (–£—Å–ª–æ–≤–Ω–æ)
    choose:
      - conditions:
          - condition: template
            value_template: >
              {% set selected_days = trigger_days %}
              {% if selected_days | length > 0 %}
                {{ now().strftime('%a') in selected_days }}
              {% else %}
                {{ true }}
              {% endif %}
        sequence:
          # 3.1 –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          - alias: –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –û—Ç—á–µ—Ç –æ –∑–∞—Ä—è–∂–∞–µ–º—ã—Ö
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mobile_device_id is not none and mobile_device_id != '' }}"
                sequence:
                  - service: notify.mobile_app_{{ device_attr(mobile_device_id, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                    data:
                      title: >
                        {% if rechargeable_message.startswith('‚ö†Ô∏è') %}
                          {{ title_short_charge_low ~ critical_threshold ~ "%" }}
                        {% else %}
                          {{ title_short_charge_ok }}
                        {% endif %}
                      message: "{{ rechargeable_message | striptags }}"
          
          # 3.2 Telegram Bot (HTML)
          - alias: Telegram - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—ã–µ ID —á–∞—Ç–æ–≤ –¥–ª—è –û—Ç—á–µ—Ç–∞ 2
            variables:
              target_chat_ids: >-
                {% set selected_entities_raw = telegram_notify_entities.entity_id | default([]) %}
                {% set selected_entities = [selected_entities_raw] | flatten %}
                {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
                {% set ns = namespace(target_ids=[]) %}
                {% for id_string in chat_id_strings %}
                  {% set cleaned_id = id_string | string | trim %}
                  {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
                    {% set id_with_hyphen = '-' ~ cleaned_id %}
                    {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
                  {% else %}
                    {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
                  {% endif %}
                {% endfor %}
                {{ ns.target_ids }}

          - alias: Telegram - –û—Ç—á–µ—Ç –æ –∑–∞—Ä—è–∂–∞–µ–º—ã—Ö (HTML)
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ target_chat_ids | length > 0 }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      target: "{{ target_chat_ids }}" 
                      message: |
                        {% set report_body = rechargeable_message %}
                        {% if report_body.startswith('‚ö†Ô∏è') %}
                          {% set header = '<b>' ~ title_short_charge_low ~ critical_threshold ~ '%</b>' %}
                        {% else %}
                          {% set header = '<b>' ~ title_short_charge_ok ~ '</b>' %}
                        {% endif %}
                        {{ header ~ "\n\n" ~ report_body }}
                      parse_mode: html
  
  # ----------------------------------------------------------------------
  # 4. –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê 3: –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
  # ----------------------------------------------------------------------
  - alias: Telegram - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—ã–µ ID —á–∞—Ç–æ–≤ –¥–ª—è –ü–æ–ª–Ω–æ–≥–æ –û—Ç—á–µ—Ç–∞
    variables:
      target_chat_ids: >-
        {% set selected_entities_raw = telegram_notify_entities.entity_id | default([]) %}
        {% set selected_entities = [selected_entities_raw] | flatten %}
        {% set chat_id_strings = selected_entities | map('regex_replace', find='^.+_', replace='') | list %}
        {% set ns = namespace(target_ids=[]) %}
        {% for id_string in chat_id_strings %}
          {% set cleaned_id = id_string | string | trim %}
          {% if cleaned_id | length > 10 and not cleaned_id.startswith('-') %}
            {% set id_with_hyphen = '-' ~ cleaned_id %}
            {% set ns.target_ids = ns.target_ids + [id_with_hyphen] %}
          {% else %}
            {% set ns.target_ids = ns.target_ids + [cleaned_id] %}
          {% endif %}
        {% endfor %}
        {{ ns.target_ids }}
    
  - alias: Telegram - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç (HTML)
    choose:
      - conditions:
          - condition: template
            value_template: "{{ target_chat_ids | length > 0 and send_full_report }}"
          - condition: template
            value_template: >
              {% set selected_days = full_report_days %}
              {% if selected_days | length > 0 %}
                {{ now().strftime('%a') in selected_days }}
              {% else %}
                {{ true }}
              {% endif %}
        sequence:
          - service: telegram_bot.send_message
            data:
              target: "{{ target_chat_ids }}" 
              message: "{{ full_report_message }}"
              parse_mode: html
    
mode: single
