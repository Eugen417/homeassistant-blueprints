id: single_light_motion_door_priority_final_with_helper
alias: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–≤–µ—Ç–æ–º- –î–≤–∏–∂–µ–Ω–∏–µ, –î–≤–µ—Ä—å –∏ –†—É—á–Ω–æ–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–° –•–ï–õ–ü–ï–†–û–ú)

blueprint:
  name: üí° –°–≤–µ—Ç- –î–≤–∏–∂–µ–Ω–∏–µ, –î–≤–µ—Ä—å –∏ –†—É—á–Ω–æ–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–° –•–µ–ª–ø–µ—Ä–æ–º)
  description: |
    –í–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é/–¥–≤–µ—Ä–∏ —Ç–æ–ª—å–∫–æ –≤ "–ù–æ—á–Ω–æ–µ" –≤—Ä–µ–º—è.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ —Å–≤–µ—Ç –±—ã–ª –≤–∫–ª—é—á–µ–Ω –≤—Ä—É—á–Ω—É—é (—Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–µ–º).
  domain: automation
  
  input:
    control_entity:
      name: üí°/‚öôÔ∏è –¶–µ–ª–µ–≤–æ–π –í—ã–∫–ª—é—á–∞—Ç–µ–ª—å/–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫
      description: –°—É—â–Ω–æ—Å—Ç—å —Ä–µ–ª–µ –∏–ª–∏ —É–º–Ω–æ–π –ª–∞–º–ø–æ—á–∫–∏, –∫–æ—Ç–æ—Ä–æ–π —É–ø—Ä–∞–≤–ª—è–µ—Ç HA.
      selector:
        entity:
          domain: [light, switch]
            
    motion_sensor:
      name: üßç –î–∞—Ç—á–∏–∫ –î–≤–∏–∂–µ–Ω–∏—è
      description: –°–µ–Ω—Å–æ—Ä –¥–ª—è –Ω–æ—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
      selector:
        entity:
          domain: binary_sensor
          
    door_sensor:
      name: üö™ –î–∞—Ç—á–∏–∫ –û—Ç–∫—Ä—ã—Ç–∏—è
      description: –°–µ–Ω—Å–æ—Ä –¥–≤–µ—Ä–∏/–æ–∫–Ω–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–≤–µ—Ç–∞.
      selector:
        entity:
          domain: binary_sensor
          
    motion_off_delay:
      name: ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é (–º–∏–Ω)
      description: –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏ (—Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é).
      default: 3
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min
          mode: slider
          
    schedule_start_time:
      name: ‚è∞ –ù–∞—á–∞–ª–æ "–î–Ω–µ–≤–Ω–æ–≥–æ" —Ä–µ–∂–∏–º–∞ (08:00)
      default: '08:00:00'
      selector:
        time:
        
    schedule_end_time:
      name: ‚è∞ –ù–∞—á–∞–ª–æ "–ù–æ—á–Ω–æ–≥–æ" —Ä–µ–∂–∏–º–∞ (21:00)
      default: '21:00:00'
      selector:
        time:

    manual_lock_helper:
      name: üö© –§–ª–∞–≥ –†—É—á–Ω–æ–π –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Input Boolean)
      description: |
        **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!** –ü–æ–º–æ—â–Ω–∏–∫ —Ç–∏–ø–∞ "–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" (Input Boolean). –û–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –±—ã–ª –ª–∏ —Å–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω –≤—Ä—É—á–Ω—É—é.
      selector:
        entity:
          domain: input_boolean
          
mode: restart

trigger:
  # 1. –¢–†–ò–ì–ì–ï–†–´ –ü–û –í–†–ï–ú–ï–ù–ò
  - platform: time
    at: !input schedule_start_time
    id: 'day_mode_start'
  - platform: time
    at: !input schedule_end_time
    id: 'night_mode_start'

  # 2. –¢–†–ò–ì–ì–ï–†–´ –ê–ö–¢–ò–í–ê–¶–ò–ò
  - platform: state
    entity_id: !input motion_sensor
    to: 'on'
    id: 'motion_on'
  - platform: state
    entity_id: !input door_sensor
    to: 'on'
    id: 'door_open'

  # 3. –¢–†–ò–ì–ì–ï–†–´ –î–ï–ê–ö–¢–ò–í–ê–¶–ò–ò (–¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏)
  - platform: state
    entity_id: !input motion_sensor
    to: 'off'
    id: 'motion_off'
  - platform: state
    entity_id: !input door_sensor
    to: 'off'
    id: 'door_close'

  # 4. –¢–†–ò–ì–ì–ï–†: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
  - platform: state
    entity_id: !input control_entity
    to: ['on', 'off']
    id: 'control_entity_change'

action:
  - choose:
    
    # =======================================================
    # 0. –£–ü–†–ê–í–õ–ï–ù–ò–ï –§–õ–ê–ì–û–ú –ë–õ–û–ö–ò–†–û–í–ö–ò (–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä—É—á–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏)
    # =======================================================
    - conditions:
        - condition: trigger
          id: 'control_entity_change'
        # –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–≤—Ä—É—á–Ω—É—é), –∞ –Ω–µ —Å–∞–º–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π.
        - condition: template
          value_template: "{{ trigger.to_state.context.user_id is not none }}"
      sequence:
        - service: "input_boolean.turn_{{ trigger.to_state.state }}"
          data: 
            entity_id: !input manual_lock_helper 
        
    # =======================================================
    # 1. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –í–ö–õ–Æ–ß–ï–ù–ò–ï (–î–≤–∏–∂–µ–Ω–∏–µ ON –∏–ª–∏ –î–≤–µ—Ä—å Open)
    # =======================================================
    - conditions:
        - condition: or
          conditions:
            # –î–≤–∏–∂–µ–Ω–∏–µ ON (—Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é)
            - condition: and
              conditions:
                - condition: trigger
                  id: 'motion_on'
                - condition: or
                  conditions:
                    - condition: time
                      before: !input schedule_start_time
                    - condition: time
                      after: !input schedule_end_time
            # –î–≤–µ—Ä—å Open (–ö–†–£–ì–õ–û–°–£–¢–û–ß–ù–û)
            - condition: trigger
              id: 'door_open'
        
        - condition: state
          entity_id: !input control_entity
          state: 'off'
        - condition: state
          entity_id: !input manual_lock_helper
          state: 'off'
      sequence:
        - service: homeassistant.turn_on 
          data: 
            entity_id: !input control_entity
          
    # =======================================================
    # 2. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –í–´–ö–õ–Æ–ß–ï–ù–ò–ï (–¢–æ–ª—å–∫–æ –ù–æ—á—å—é)
    # =======================================================
    - conditions:
        - condition: or
          conditions:
            - condition: trigger
              id: 'motion_off'
            - condition: trigger
              id: 'door_close'
        # –£—Å–ª–æ–≤–∏–µ 1: –°–µ–π—á–∞—Å –ù–æ—á—å
        - condition: or
          conditions:
            - condition: time
              before: !input schedule_start_time
            - condition: time
              after: !input schedule_end_time
        - condition: state
          entity_id: !input control_entity
          state: 'on'
        - condition: state
          entity_id: !input manual_lock_helper
          state: 'off'
      sequence:
        - delay: 
            minutes: !input motion_off_delay
        
        - choose:
          - conditions:
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
              - condition: state
                entity_id: !input motion_sensor
                state: 'off'
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –î–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–∞
              - condition: state
                entity_id: !input door_sensor
                state: 'off'
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –°–≤–µ—Ç –≤—Å–µ –µ—â–µ ON
              - condition: state
                entity_id: !input control_entity
                state: 'on'
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –§–ª–∞–≥ –≤—Å–µ –µ—â–µ OFF
              - condition: state
                entity_id: !input manual_lock_helper
                state: 'off'
            sequence:
              - service: homeassistant.turn_off
                data: 
                  entity_id: !input control_entity

    # =======================================================
    # 3. –û–ë–†–ê–ë–û–¢–ö–ê –í–†–ï–ú–ï–ù–ò (–ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—é)
    # =======================================================
    
    # 3.1: –ù–ê–ß–ê–õ–û –î–ù–ï–í–ù–û–ì–û –†–ï–ñ–ò–ú–ê (08:00)
    - conditions:
        - condition: trigger
          id: 'day_mode_start'
        - condition: state
          entity_id: !input control_entity
          state: 'on'
        - condition: state
          entity_id: !input manual_lock_helper
          state: 'off'
      sequence:
        - service: homeassistant.turn_off
          data: 
            entity_id: !input control_entity
          
    # 3.2: –ù–ê–ß–ê–õ–û –ù–û–ß–ù–û–ì–û –†–ï–ñ–ò–ú–ê (21:00)
    - conditions:
        - condition: trigger
          id: 'night_mode_start'
      sequence: []
          
    default: []
