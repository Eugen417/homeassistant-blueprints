id: single_light_door_priority
alias: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–≤–µ—Ç–æ–º- –î–≤–µ—Ä—å –∏ –†—É—á–Ω–æ–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç

blueprint:
  name: üö™ –°–≤–µ—Ç- –î–≤–µ—Ä—å + –†—É—á–Ω–æ–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (24/7)
  description: |
    –í–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏ –∏ –≤—ã–∫–ª—é—á–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è.
    
    **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –≤—Ä—É—á–Ω—É—é (—Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–µ–º) –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ.
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/swet_2.yaml
  
  input:
    control_entity:
      name: üí° –¶–µ–ª–µ–≤–æ–π –í—ã–∫–ª—é—á–∞—Ç–µ–ª—å/–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫
      description: –°—É—â–Ω–æ—Å—Ç—å —Ä–µ–ª–µ –∏–ª–∏ —É–º–Ω–æ–π –ª–∞–º–ø–æ—á–∫–∏, –∫–æ—Ç–æ—Ä–æ–π —É–ø—Ä–∞–≤–ª—è–µ—Ç HA.
      selector:
        entity:
          domain: [light, switch]
            
    door_sensor:
      name: üö™ –î–∞—Ç—á–∏–∫ –û—Ç–∫—Ä—ã—Ç–∏—è
      description: –°–µ–Ω—Å–æ—Ä –¥–≤–µ—Ä–∏/–æ–∫–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–≤–µ—Ç.
      selector:
        entity:
          domain: binary_sensor
          
    off_delay:
      name: ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è (–º–∏–Ω)
      description: –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏.
      default: 3
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min
          mode: slider
          
    manual_lock_helper:
      name: üö© –§–ª–∞–≥ –†—É—á–Ω–æ–π –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Input Boolean)
      description: |
        **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** –ü–æ–º–æ—â–Ω–∏–∫ —Ç–∏–ø–∞ "–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" (Input Boolean). –û–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –±—ã–ª –ª–∏ —Å–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω –≤—Ä—É—á–Ω—É—é.
      selector:
        entity:
          domain: input_boolean
          
mode: restart

trigger:
  # 1. –¢–†–ò–ì–ì–ï–†: –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏ (–í–ö–õ–Æ–ß–ï–ù–ò–ï)
  - platform: state
    entity_id: !input door_sensor
    to: 'on'
    id: 'door_open'

  # 2. –¢–†–ò–ì–ì–ï–†: –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏ (–ó–ê–ü–£–°–ö –ó–ê–î–ï–†–ñ–ö–ò)
  - platform: state
    entity_id: !input door_sensor
    to: 'off'
    id: 'door_close'

  # 3. –¢–†–ò–ì–ì–ï–†: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
  - platform: state
    entity_id: !input control_entity
    to: ['on', 'off']
    id: 'control_entity_change'

action:
  - choose:
    
    # =======================================================
    # 0. –£–ü–†–ê–í–õ–ï–ù–ò–ï –§–õ–ê–ì–û–ú –ë–õ–û–ö–ò–†–û–í–ö–ò (–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä—É—á–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏)
    # =======================================================
    - conditions:
        - condition: trigger
          id: 'control_entity_change'
        # –§–∏–ª—å—Ç—Ä: –§–ª–∞–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –±—ã–ª–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        - condition: template
          value_template: "{{ trigger.to_state.context.user_id is not none }}"
      sequence:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –≤ ON, –µ—Å–ª–∏ —Å–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω, –∏ –≤ OFF, –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω.
        - service: "input_boolean.turn_{{ trigger.to_state.state }}"
          data: 
            entity_id: !input manual_lock_helper 
        
    # =======================================================
    # 1. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –í–ö–õ–Æ–ß–ï–ù–ò–ï (–î–≤–µ—Ä—å Open, 24/7)
    # =======================================================
    - conditions:
        - condition: trigger
          id: 'door_open'
        - condition: state
          entity_id: !input control_entity
          state: 'off'
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–µ—Ç —Ä—É—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        - condition: state
          entity_id: !input manual_lock_helper
          state: 'off'
      sequence:
        - service: homeassistant.turn_on 
          data: 
            entity_id: !input control_entity
          
    # =======================================================
    # 2. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –í–´–ö–õ–Æ–ß–ï–ù–ò–ï (–î–≤–µ—Ä—å Close, 24/7)
    # =======================================================
    - conditions:
        - condition: trigger
          id: 'door_close'
        - condition: state
          entity_id: !input control_entity
          state: 'on'
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–µ—Ç —Ä—É—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        - condition: state
          entity_id: !input manual_lock_helper
          state: 'off'
      sequence:
        - delay: 
            minutes: !input off_delay
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏
        - choose:
          - conditions:
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –î–≤–µ—Ä—å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç–æ–π
              - condition: state
                entity_id: !input door_sensor
                state: 'off'
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –°–≤–µ—Ç –≤—Å–µ –µ—â–µ ON
              - condition: state
                entity_id: !input control_entity
                state: 'on'
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –§–ª–∞–≥ –≤—Å–µ –µ—â–µ OFF (–ù–µ –±—ã–ª–æ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞)
              - condition: state
                entity_id: !input manual_lock_helper
                state: 'off'
            sequence:
              - service: homeassistant.turn_off
                data: 
                  entity_id: !input control_entity

    default: []