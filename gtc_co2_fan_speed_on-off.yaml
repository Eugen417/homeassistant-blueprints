blueprint:
  name: üí® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–µ–π –ø–æ CO2 v13.5 (–§–ò–ù–ê–õ)
  description: >-
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º –ø–æ CO2,
    –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–º–æ—â–Ω–∏–∫ `input_select` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –∏
    –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞. –î–æ–±–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ CO2
    –≤—ã—Å–æ–∫–∏–π, –Ω–æ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ, —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è.
    **–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ 'too many values to unpack' –∏ —É–ª—É—á—à–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram.
  domain: automation
  source_url: https://raw.githubusercontent.com/Eugen417/homeassistant-blueprints/refs/heads/main/gtc_co2_v13.1.yaml # –ò–∑–º–µ–Ω–∏—Ç–µ URL, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

  input:
    co2_sensors:
      name: –î–∞—Ç—á–∏–∫–∏ CO2
      description: –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç—á–∏–∫–æ–≤ CO2.
      selector:
        entity:
          domain: sensor
          device_class: carbon_dioxide
          multiple: true
    target_fan:
      name: –¶–µ–ª–µ–≤–æ–π –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä
      description: >-
        –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è.
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å —Å –¥–æ–º–µ–Ω–Ω–æ–º `fan` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `fan.gtc_fan`),**
        –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (`set_percentage`).
      default: fan.gtc_fan
      selector:
        entity:
          domain: fan
    automation_mode_select:
      name: –ü–æ–º–æ—â–Ω–∏–∫ –†–µ–∂–∏–º–∞ (Input Select)
      description: >-
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π** `input_select` —Å –æ–ø—Ü–∏—è–º–∏: **`RUNNING`** –∏ **`WAITING`**.
      selector:
        entity:
          domain: input_select
    previous_co2_helper:
      name: –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ CO2
      description: >-
        **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π** `input_number` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è CO2.
      selector:
        entity:
          domain: input_number
    low_co2_max:
      name: –ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ CO2 (–º–∞–∫—Å, ppm)
      default: 600
      selector:
        number: { min: 400, max: 1000, step: 1, mode: box, unit_of_measurement: ppm }
    max_speed:
      name: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞ (%)
      default: 40
      selector:
        number: { min: 10, max: 100, step: 10, mode: slider, unit_of_measurement: '%' }
    co2_increase_threshold:
      name: –ü–æ—Ä–æ–≥ –ø–æ–≤—ã—à–µ–Ω–∏—è CO2 –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è (ppm)
      default: 15
      selector:
        number: { min: 0, max: 100, step: 1, mode: box, unit_of_measurement: ppm }
    co2_change_threshold:
      name: –ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è CO2 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (ppm)
      default: 15
      selector:
        number: { min: 0, max: 50, step: 1, mode: box, unit_of_measurement: ppm }
    start_speed:
      name: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–°—Ç–∞—Ä—Ç–æ–≤–∞—è –°–∫–æ—Ä–æ—Å—Ç—å (%)
      default: 0
      selector:
        number: { min: 0, max: 100, step: 10, mode: slider, unit_of_measurement: '%' }
    update_frequency:
      name: –ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (minutes)
      default: "/5"
      selector:
        text:

    # –ü–û–õ–Ø –î–õ–Ø TELEGRAM
    telegram_notify_target:
      name: üí¨ Telegram –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
      description: –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ Telegram —Å–µ—Ä–≤–∏—Å–∞ (notify.telegram_bot_...). –ò—Ö ID –±—É–¥—É—Ç –∏–∑–≤–ª–µ—á–µ–Ω—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `telegram_bot.send_message`.
      default:
        entity_id: []
      selector:
        target:
          entity:
            - domain: notify

mode: single
trigger:
  - platform: time_pattern
    minutes: !input update_frequency
action:
  - variables:
      co2_sensors_list: !input co2_sensors
      target_fan_entity: !input target_fan
      low_co2_max_val: !input low_co2_max
      max_speed_val: !input max_speed
      co2_increase_threshold_val: !input co2_increase_threshold
      co2_change_threshold_val: !input co2_change_threshold
      start_speed_val: !input start_speed
      previous_co2_helper_entity_id: !input previous_co2_helper
      mode_select_entity_id: !input automation_mode_select
      telegram_notify_entities: !input telegram_notify_target

      current_mode: "{{ states(mode_select_entity_id) }}"
      is_fan_on: "{{ is_state(target_fan_entity, 'on') }}"

      min_fan_speed: >
        {% if start_speed_val | float == 0 %} 10 {% else %} {{ start_speed_val }} {% endif %}

      avg_co2: >
        {% set valid = co2_sensors_list | map('states') | map('float',0) | select('>',0) | list %}
        {% if valid | length > 0 %} {{ (valid | sum / valid | length) | round(1) }} {% else %} 0 {% endif %}

      current_speed: "{{ state_attr(target_fan_entity, 'percentage') | float(0) }}"
      previous_co2: "{{ states(previous_co2_helper_entity_id) | float(0) }}"

      # --- –ò–ó–í–õ–ï–ß–ï–ù–ò–ï ID –ß–ê–¢–û–í (–∫–∞–∫ –≤ Blueprint'–µ –±–∞—Ç–∞—Ä–µ–π) ---
      target_chat_ids: >-
        {% set selected = telegram_notify_entities.entity_id | default([]) %}
        {% set ids = selected | map('regex_replace', find='^.+_', replace='') | list %}
        {% set ns = namespace(targets=[]) %}
        {% for id_str in ids %}
          {% set clean_id = id_str | string | trim %}
          {% if clean_id | length > 10 and not clean_id.startswith('-') %}
            {% set ns.targets = ns.targets + ['-' ~ clean_id] %}
          {% else %}
            {% set ns.targets = ns.targets + [clean_id] %}
          {% endif %}
        {% endfor %}
        {{ ns.targets }}

  - choose:
      # --- –õ–û–ì–ò–ö–ê 1: –í–ö–õ–Æ–ß–ï–ù–ò–ï –í–ï–ù–¢–ò–õ–Ø–¢–û–†–ê ---
      - conditions:
          - condition: template
            value_template: "{{ not is_fan_on }}"
          - condition: template
            value_template: >
              {{ avg_co2 >= (low_co2_max_val | float + co2_increase_threshold_val | float) }}
          - condition: template
            value_template: "{{ current_mode == 'RUNNING' }}"
        sequence:
          - service: fan.turn_on
            target: { entity_id: "{{ target_fan_entity }}" }
          - delay: { seconds: 50 }
          - service: fan.set_percentage
            target: { entity_id: "{{ target_fan_entity }}" }
            data: { percentage: "{{ min_fan_speed }}" }
          - service: input_select.select_option
            target: { entity_id: "{{ mode_select_entity_id }}" }
            data: { option: WAITING }

      # --- –õ–û–ì–ò–ö–ê 2: –í–ï–ù–¢–ò–õ–Ø–¢–û–† –í–ö–õ–Æ–ß–ï–ù ---
      - conditions:
          - condition: template
            value_template: "{{ is_fan_on }}"
        sequence:
          - choose:
              # –í–´–ö–õ–Æ–ß–ï–ù–ò–ï / –ú–ò–ù. –°–ö–û–†–û–°–¢–¨
              - conditions:
                  - condition: template
                    value_template: |
                      {{ avg_co2 < low_co2_max_val | float }}
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ start_speed_val | float == 0 }}"
                    then:
                      - service: fan.set_percentage
                        target: { entity_id: "{{ target_fan_entity }}" }
                        data: { percentage: 10 }
                      - delay: { seconds: 5 }
                      - service: fan.turn_off
                        target: { entity_id: "{{ target_fan_entity }}" }
                      - service: input_select.select_option
                        target: { entity_id: "{{ mode_select_entity_id }}" }
                        data: { option: RUNNING }
                    else:
                      - service: fan.set_percentage
                        target: { entity_id: "{{ target_fan_entity }}" }
                        data: { percentage: "{{ start_speed_val }}" }
              # –°–ù–ò–ñ–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò
              - conditions:
                  - condition: template
                    value_template: >
                      {{ (previous_co2 - avg_co2) >= co2_change_threshold_val | float }}
                sequence:
                  - variables: { new_speed: "{{ [current_speed - 10, min_fan_speed] | max }}" }
                  - service: fan.set_percentage
                    target: { entity_id: "{{ target_fan_entity }}" }
                    data: { percentage: "{{ new_speed }}" }
              # –ü–û–í–´–®–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò
              - conditions:
                  - condition: template
                    value_template: |
                      {{ avg_co2 > previous_co2 }}
                sequence:
                  - variables: { new_speed: "{{ [current_speed + 10, max_speed_val] | min }}" }
                  - service: fan.set_percentage
                    target: { entity_id: "{{ target_fan_entity }}" }
                    data: { percentage: "{{ new_speed }}" }

  # --------------------------------------------------------------------------
  # --- –õ–û–ì–ò–ö–ê 3: –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–õ–û–ö–ò–†–û–í–ö–ï (–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –±–ª–æ–∫) ---
  # --------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template # –í—ã—Å–æ–∫–∏–π CO2
            value_template: >
              {{ avg_co2 >= (low_co2_max_val | float + co2_increase_threshold_val | float) }}
          - condition: template # –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω
            value_template: "{{ not is_fan_on }}"
          - condition: template # –†–µ–∂–∏–º WAITING
            value_template: "{{ current_mode == 'WAITING' }}"
          - condition: template # –í—ã–±—Ä–∞–Ω—ã —Ü–µ–ª–∏ Telegram
            value_template: "{{ target_chat_ids | length > 0 }}"
        sequence:
          - service: telegram_bot.send_message
            data:
              target: "{{ target_chat_ids }}"
              
              message: >
                {# 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ó–∞–≥–æ–ª–æ–≤–∫–∞ (Title) #}
                {%- set message_title = "üí® \*–í–Ω–∏–º–∞–Ω–∏–µ: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –í–µ–Ω—Ç—É—Å—Ç–∞–Ω–æ–≤–∫–∏\*" %}
                
                {# 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¢–µ–ª–∞ –°–æ–æ–±—â–µ–Ω–∏—è (Message Body) #}
                {%- set raw_message_body = "–£—Ä–æ–≤–µ–Ω—å CO2 (" ~ (avg_co2 | round(0)) ~ " ppm) –≤—ã—à–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ (–ø–æ—Ä–æ–≥: " ~ ((low_co2_max_val | float + co2_increase_threshold_val | float) | round(0)) ~ " ppm), –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–Ω—Ç—É—Å—Ç–∞–Ω–æ–≤–∫—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥—Ä—É–≥–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π. –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: WAITING." %}
                
                {# 3. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è MarkdownV2 (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Ç–µ–ª—É!) #}
                {%- set escaped_body = raw_message_body | replace('&', '&amp;') | replace('~', '\~') | replace('`', '\`') | replace('>', '\>') | replace('#', '\#') | replace('+', '\+') | replace('-', '\-') | replace('=', '\=') | replace('|', '\|') | replace('{', '\{') | replace('}', '\}') | replace('.', '\.') | replace('!', '\!') | replace('*', '\*') | replace('_', '\_') | replace('[', '\[') | replace(']', '\]') | replace('(', '\(') | replace(')', '\)') | replace('%', '\%') %}
                
                {# 4. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ó–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –¢–µ–ª–∞ #}
                {{ message_title ~ "\n\n" ~ escaped_body }}
              
              parse_mode: markdownv2
              
              # –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í–ê–® –†–ê–ë–û–ß–ò–ô –§–û–†–ú–ê–¢ –ö–ù–û–ü–ö–ò
              inline_keyboard:
                - –í–ö–õ–Æ–ß–ò–¢–¨ FAN:/turn_on_gtc_fan

  # –û–ë–ù–û–í–õ–ï–ù–ò–ï CO2
  - service: input_number.set_value
    data:
      entity_id: "{{ previous_co2_helper_entity_id }}"
      value: "{{ avg_co2 }}"
